<!DOCTYPE html>
<html style="display: none;" lang="zh">
    <head>
    <meta charset="utf-8">
    <!--
        © Material Theme
        https://github.com/bollnh/hexo-theme-material
        Version: 1.5.6 -->
    <script>
        window.materialVersion = "1.5.6"
        // Delete localstorage with these tags
        window.oldVersion = [
            'codestartv1',
            '1.3.4',
            '1.4.0',
            '1.4.0b1',
            '1.5.0',
            '1.5.2',
            '1.5.5'
        ]
    </script>

    <!-- dns prefetch -->
    <meta http-equiv="x-dns-prefetch-control" content="on">





    <link rel="dns-prefetch" href="https://.disqus.com"/>





    <link rel="dns-prefetch" href="https://fonts.googleapis.com"/>





    <!-- Meta & Info -->
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!-- Title -->
    
    <title>
        
            redis源码 | 
        
        Believe it
    </title>

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/material/img/favicon.svg">
    <link rel="icon" href="/material/img/favicon.svg">

    <meta name="format-detection" content="telephone=no"/>
    <meta name="description" itemprop="description" content="nexthexonextbutterflyvolantisyearnyiliashokaindigoapollolandscapecactusmateryicarusfluidmaterial



版本使用6.2.4
sds.h sds.c内存对齐__attribute__((__packed__))可以让编译器对结构体不进行内存对齐，详细参考
1234567891011121314151617181920212223242526#include &amp;lt;stdint.h&amp;gt;#include &amp;lt;stdio.h&amp;gt;struct __attribute__((__packed__)) sdshdr64 &amp;#123;    uint64_t len;        /* used */    uint64_t alloc;      /* excluding the header and null terminator */    unsigned char flags; /* 3 lsb of type, 5 unused bits */    char buf[];&amp;#125;;struct _sdshdr64 &amp;#123;    uint64_t len;        /* used */    uint64_t alloc;      /* excluding the header and null terminator */    unsigned char flags; /* 3 lsb of type, 5 unused bits */    char buf[];&amp;#125;;int main() &amp;#123;    printf(&amp;quot;packed: %d\n&amp;quot;, sizeof(struct sdshdr64));    printf(&amp;quot;nopacked: %d\n&amp;quot;, sizeof(struct _sdshdr64));&amp;#125;/*gcc a.c -o a &amp;amp;&amp;amp; ./apacked: 17nopacked: 24*/

宏####后标识的字符串会被替换，然后其左右的内容加上自己会被合并到一起，编译器将其视为标识符进行解析，详细参考">
    <meta name="keywords" content="">
    <meta name="theme-color" content="#0097A7">

    <!-- Disable Fucking Bloody Baidu Tranformation -->
    <meta http-equiv="Cache-Control" content="no-transform" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->

    <!-- Import lsloader -->
    <script>(function(){window.lsloader={jsRunSequence:[],jsnamemap:{},cssnamemap:{}};lsloader.removeLS=function(a){try{localStorage.removeItem(a)}catch(b){}};lsloader.setLS=function(a,c){try{localStorage.setItem(a,c)}catch(b){}};lsloader.getLS=function(a){var c="";try{c=localStorage.getItem(a)}catch(b){c=""}return c};versionString="/*"+(window.materialVersion||"unknownVersion")+"*/";lsloader.clean=function(){try{var b=[];for(var a=0;a<localStorage.length;a++){b.push(localStorage.key(a))}b.forEach(function(e){var f=lsloader.getLS(e);if(window.oldVersion){var d=window.oldVersion.reduce(function(g,h){return g||f.indexOf("/*"+h+"*/")!==-1},false);if(d){lsloader.removeLS(e)}}})}catch(c){}};lsloader.clean();lsloader.load=function(f,a,b,d){if(typeof b==="boolean"){d=b;b=undefined}d=d||false;b=b||function(){};var e;e=this.getLS(f);if(e&&e.indexOf(versionString)===-1){this.removeLS(f);this.requestResource(f,a,b,d);return}if(e){var c=e.split(versionString)[0];if(c!=a){console.log("reload:"+a);this.removeLS(f);this.requestResource(f,a,b,d);return}e=e.split(versionString)[1];if(d){this.jsRunSequence.push({name:f,code:e});this.runjs(a,f,e)}else{document.getElementById(f).appendChild(document.createTextNode(e));b()}}else{this.requestResource(f,a,b,d)}};lsloader.requestResource=function(b,e,a,c){var d=this;if(c){this.iojs(e,b,function(h,f,g){d.setLS(f,h+versionString+g);d.runjs(h,f,g)})}else{this.iocss(e,b,function(f){document.getElementById(b).appendChild(document.createTextNode(f));d.setLS(b,e+versionString+f)},a)}};lsloader.iojs=function(d,b,g){var a=this;a.jsRunSequence.push({name:b,code:""});try{var f=new XMLHttpRequest();f.open("get",d,true);f.onreadystatechange=function(){if(f.readyState==4){if((f.status>=200&&f.status<300)||f.status==304){if(f.response!=""){g(d,b,f.response);return}}a.jsfallback(d,b)}};f.send(null)}catch(c){a.jsfallback(d,b)}};lsloader.iocss=function(f,c,h,a){var b=this;try{var g=new XMLHttpRequest();g.open("get",f,true);g.onreadystatechange=function(){if(g.readyState==4){if((g.status>=200&&g.status<300)||g.status==304){if(g.response!=""){h(g.response);a();return}}b.cssfallback(f,c,a)}};g.send(null)}catch(d){b.cssfallback(f,c,a)}};lsloader.iofonts=function(f,c,h,a){var b=this;try{var g=new XMLHttpRequest();g.open("get",f,true);g.onreadystatechange=function(){if(g.readyState==4){if((g.status>=200&&g.status<300)||g.status==304){if(g.response!=""){h(g.response);a();return}}b.cssfallback(f,c,a)}};g.send(null)}catch(d){b.cssfallback(f,c,a)}};lsloader.runjs=function(f,c,e){if(!!c&&!!e){for(var b in this.jsRunSequence){if(this.jsRunSequence[b].name==c){this.jsRunSequence[b].code=e}}}if(!!this.jsRunSequence[0]&&!!this.jsRunSequence[0].code&&this.jsRunSequence[0].status!="failed"){var a=document.createElement("script");a.appendChild(document.createTextNode(this.jsRunSequence[0].code));a.type="text/javascript";document.getElementsByTagName("head")[0].appendChild(a);this.jsRunSequence.shift();if(this.jsRunSequence.length>0){this.runjs()}}else{if(!!this.jsRunSequence[0]&&this.jsRunSequence[0].status=="failed"){var d=this;var a=document.createElement("script");a.src=this.jsRunSequence[0].path;a.type="text/javascript";this.jsRunSequence[0].status="loading";a.onload=function(){d.jsRunSequence.shift();if(d.jsRunSequence.length>0){d.runjs()}};document.body.appendChild(a)}}};lsloader.tagLoad=function(b,a){this.jsRunSequence.push({name:a,code:"",path:b,status:"failed"});this.runjs()};lsloader.jsfallback=function(c,b){if(!!this.jsnamemap[b]){return}else{this.jsnamemap[b]=b}for(var a in this.jsRunSequence){if(this.jsRunSequence[a].name==b){this.jsRunSequence[a].code="";this.jsRunSequence[a].status="failed";this.jsRunSequence[a].path=c}}this.runjs()};lsloader.cssfallback=function(e,c,b){if(!!this.cssnamemap[c]){return}else{this.cssnamemap[c]=1}var d=document.createElement("link");d.type="text/css";d.href=e;d.rel="stylesheet";d.onload=d.onerror=b;var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(d,a)};lsloader.runInlineScript=function(c,b){var a=document.getElementById(b).innerText;this.jsRunSequence.push({name:c,code:a});this.runjs()}})();</script>

    <!-- Import queue -->
    <script>function Queue(){this.dataStore=[];this.offer=b;this.poll=d;this.execNext=a;this.debug=false;this.startDebug=c;function b(e){if(this.debug){console.log("Offered a Queued Function.")}if(typeof e==="function"){this.dataStore.push(e)}else{console.log("You must offer a function.")}}function d(){if(this.debug){console.log("Polled a Queued Function.")}return this.dataStore.shift()}function a(){var e=this.poll();if(e!==undefined){if(this.debug){console.log("Run a Queued Function.")}e()}}function c(){this.debug=true}}var queue=new Queue();</script>

    <!-- Import CSS -->
    
        <style id="material_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("material_css","/material/css/material.min.css?Z7a72R1E4SxzBKR/WGctOA==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>
        <style id="style_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("style_css","/material/css/style.min.css?NKhlKQkXw/c66TR5p4wO+w==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>

        

    

    

    <!-- Config CSS -->

<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
    overflow-x: hidden !important;
  }
  
  code {
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }

</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-color: #F5F5F5;
      }

      /* blog_info bottom background */
      #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
        background-color: #fff;
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>


<!-- Import Font -->
<!-- Import Roboto -->

    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet">


<!-- Import Material Icons -->


    <style id="material_icons"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("material_icons","/material/css/material-icons.css?pqhB/Rd/ab0H2+kZp0RDmw==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>




    <!-- Import jQuery -->
    
        <script>lsloader.load("jq_js","/material/js/jquery.min.js?qcusAULNeBksqffqUM2+Ig==", true)</script>
    

    <!-- WebAPP Icons -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Believe it">
    <meta name="msapplication-starturl" content="http://fightinggg.github.io/material/material/QVAQR0.html">
    <meta name="msapplication-navbutton-color" content="#0097A7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Believe it">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon" href="/material/img/favicon.svg">

    <!-- Site Verification -->
    
    

    <!-- RSS -->
    

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://fightinggg.github.io/material/material/QVAQR0.html">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="redis源码 | Believe it">
    <meta property="og:image" content="/material/img/favicon.svg">
    <meta property="og:description" content="nexthexonextbutterflyvolantisyearnyiliashokaindigoapollolandscapecactusmateryicarusfluidmaterial



版本使用6.2.4
sds.h sds.c内存对齐__attribute__((__packed__))可以让编译器对结构体不进行内存对齐，详细参考
1234567891011121314151617181920212223242526#include &amp;lt;stdint.h&amp;gt;#include &amp;lt;stdio.h&amp;gt;struct __attribute__((__packed__)) sdshdr64 &amp;#123;    uint64_t len;        /* used */    uint64_t alloc;      /* excluding the header and null terminator */    unsigned char flags; /* 3 lsb of type, 5 unused bits */    char buf[];&amp;#125;;struct _sdshdr64 &amp;#123;    uint64_t len;        /* used */    uint64_t alloc;      /* excluding the header and null terminator */    unsigned char flags; /* 3 lsb of type, 5 unused bits */    char buf[];&amp;#125;;int main() &amp;#123;    printf(&amp;quot;packed: %d\n&amp;quot;, sizeof(struct sdshdr64));    printf(&amp;quot;nopacked: %d\n&amp;quot;, sizeof(struct _sdshdr64));&amp;#125;/*gcc a.c -o a &amp;amp;&amp;amp; ./apacked: 17nopacked: 24*/

宏####后标识的字符串会被替换，然后其左右的内容加上自己会被合并到一起，编译器将其视为标识符进行解析，详细参考">
    

    
        <meta property="article:published_time" content="Sat Jun 26 2021 14:45:00 GMT+0800">
        <meta property="article:modified_time" content="Sat Jun 26 2021 06:45:00 GMT+0000">
    

    <!-- The Twitter Card protocol -->
    <meta name="twitter:card" content="summary_large_image">

    <!-- Add canonical link for SEO -->
    
        <link rel="canonical" href="http://fightinggg.github.io/material/material/QVAQR0.html" />
    

    <!-- Structured-data for SEO -->
    
        


<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage": "http://fightinggg.github.io/material/material/QVAQR0.html",
    "headline": "redis源码",
    "datePublished": "Sat Jun 26 2021 14:45:00 GMT+0800",
    "dateModified": "Sat Jun 26 2021 06:45:00 GMT+0000",
    "author": {
        "@type": "Person",
        "name": "fightinggg",
        "image": {
            "@type": "ImageObject",
            "url": "/img/avatar.png"
        },
        "description": "Hi, nice to meet you"
    },
    "publisher": {
        "@type": "Organization",
        "name": "Believe it",
        "logo": {
            "@type":"ImageObject",
            "url": "/img/favicon.svg"
        }
    },
    "keywords": "",
    "description": "nexthexonextbutterflyvolantisyearnyiliashokaindigoapollolandscapecactusmateryicarusfluidmaterial



版本使用6.2.4
sds.h sds.c内存对齐__attribute__((__packed__))可以让编译器对结构体不进行内存对齐，详细参考
1234567891011121314151617181920212223242526#include &amp;lt;stdint.h&amp;gt;#include &amp;lt;stdio.h&amp;gt;struct __attribute__((__packed__)) sdshdr64 &amp;#123;    uint64_t len;        /* used */    uint64_t alloc;      /* excluding the header and null terminator */    unsigned char flags; /* 3 lsb of type, 5 unused bits */    char buf[];&amp;#125;;struct _sdshdr64 &amp;#123;    uint64_t len;        /* used */    uint64_t alloc;      /* excluding the header and null terminator */    unsigned char flags; /* 3 lsb of type, 5 unused bits */    char buf[];&amp;#125;;int main() &amp;#123;    printf(&amp;quot;packed: %d\n&amp;quot;, sizeof(struct sdshdr64));    printf(&amp;quot;nopacked: %d\n&amp;quot;, sizeof(struct _sdshdr64));&amp;#125;/*gcc a.c -o a &amp;amp;&amp;amp; ./apacked: 17nopacked: 24*/

宏####后标识的字符串会被替换，然后其左右的内容加上自己会被合并到一起，编译器将其视为标识符进行解析，详细参考",
}
</script>


    

    <!-- Analytics -->
    
    
    

    <!-- Custom Head -->
    

<meta name="generator" content="Hexo 6.3.0"></head>


    
        <body id="scheme-Paradox" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span id="MD-burger-id" class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->


    <!-- Left aligned menu below button -->
    
    
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn" style="max-height:80vh; overflow-y:scroll;">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E7%89%88%E6%9C%AC"><span class="post-toc-number">1.</span> <span class="post-toc-text">版本</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#sds-h-sds-c"><span class="post-toc-number">2.</span> <span class="post-toc-text">sds.h sds.c</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">内存对齐</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%AE%8F"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">宏##</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#sds-h-%E6%BA%90%E7%A0%81"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">sds.h 源码</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#adlist-c-adlist-h"><span class="post-toc-number">3.</span> <span class="post-toc-text">adlist.c adlist.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#mt19937-64-c-mt19937-64-h"><span class="post-toc-number">4.</span> <span class="post-toc-text">mt19937-64.c mt19937-64.h</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E6%A2%85%E6%A3%AE%E7%B4%A0%E6%95%B0"><span class="post-toc-number">4.1.</span> <span class="post-toc-text">梅森素数</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E7%BA%BF%E6%80%A7%E5%8F%8D%E9%A6%88%E7%A7%BB%E4%BD%8D%E5%AF%84%E5%AD%98%E5%99%A8"><span class="post-toc-number">4.2.</span> <span class="post-toc-text">线性反馈移位寄存器</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E6%A2%85%E6%A3%AE%E6%97%8B%E8%BD%AC%E7%AE%97%E6%B3%95"><span class="post-toc-number">4.3.</span> <span class="post-toc-text">梅森旋转算法</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#mt19937%E6%BA%90%E7%A0%81"><span class="post-toc-number">4.4.</span> <span class="post-toc-text">mt19937源码</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#dict-c-dict-h"><span class="post-toc-number">5.</span> <span class="post-toc-text">dict.c dict.h</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%AD%97%E5%85%B8%E6%BA%90%E7%A0%81"><span class="post-toc-number">5.1.</span> <span class="post-toc-text">字典源码</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#server-h-server-c-1-%E8%B7%B3%E8%A1%A8"><span class="post-toc-number">6.</span> <span class="post-toc-text">server.h server.c-1-跳表</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#intset-c-intset-h"><span class="post-toc-number">7.</span> <span class="post-toc-text">intset.c intset.h</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E6%95%B4%E6%95%B0%E9%9B%86%E5%90%88%E5%8D%87%E7%BA%A7"><span class="post-toc-number">7.1.</span> <span class="post-toc-text">整数集合升级</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#ziplist-c-ziplist-h"><span class="post-toc-number">8.</span> <span class="post-toc-text">ziplist.c ziplist.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#server-h-server-c-2-%E5%AF%B9%E8%B1%A1"><span class="post-toc-number">9.</span> <span class="post-toc-text">server.h server.c-2-对象</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#server-h-3-db"><span class="post-toc-number">10.</span> <span class="post-toc-text">server.h-3-db</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#rio-c-rio-h"><span class="post-toc-number">11.</span> <span class="post-toc-text">rio.c rio.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#rdb-c-rdb-h"><span class="post-toc-number">12.</span> <span class="post-toc-text">rdb.c rdb.h</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#rdbSaveRio"><span class="post-toc-number">12.1.</span> <span class="post-toc-text">rdbSaveRio</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#rdbSave"><span class="post-toc-number">12.2.</span> <span class="post-toc-text">rdbSave</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#rdbSaveBackground"><span class="post-toc-number">12.3.</span> <span class="post-toc-text">rdbSaveBackground</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Makefile"><span class="post-toc-number">13.</span> <span class="post-toc-text">Makefile</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#acl-c"><span class="post-toc-number">14.</span> <span class="post-toc-text">acl.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#ae-c"><span class="post-toc-number">15.</span> <span class="post-toc-text">ae.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#ae-h"><span class="post-toc-number">16.</span> <span class="post-toc-text">ae.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#ae-epoll-c"><span class="post-toc-number">17.</span> <span class="post-toc-text">ae_epoll.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#ae-evport-c"><span class="post-toc-number">18.</span> <span class="post-toc-text">ae_evport.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#ae-kqueue-c"><span class="post-toc-number">19.</span> <span class="post-toc-text">ae_kqueue.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#ae-select-c"><span class="post-toc-number">20.</span> <span class="post-toc-text">ae_select.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#anet-c"><span class="post-toc-number">21.</span> <span class="post-toc-text">anet.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#anet-h"><span class="post-toc-number">22.</span> <span class="post-toc-text">anet.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#aof-c"><span class="post-toc-number">23.</span> <span class="post-toc-text">aof.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#asciilogo-h"><span class="post-toc-number">24.</span> <span class="post-toc-text">asciilogo.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#atomicvar-h"><span class="post-toc-number">25.</span> <span class="post-toc-text">atomicvar.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#bio-c"><span class="post-toc-number">26.</span> <span class="post-toc-text">bio.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#bio-h"><span class="post-toc-number">27.</span> <span class="post-toc-text">bio.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#bitops-c"><span class="post-toc-number">28.</span> <span class="post-toc-text">bitops.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#blocked-c"><span class="post-toc-number">29.</span> <span class="post-toc-text">blocked.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#childinfo-c"><span class="post-toc-number">30.</span> <span class="post-toc-text">childinfo.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#cli-common-c"><span class="post-toc-number">31.</span> <span class="post-toc-text">cli_common.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#cli-common-h"><span class="post-toc-number">32.</span> <span class="post-toc-text">cli_common.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#cluster-c"><span class="post-toc-number">33.</span> <span class="post-toc-text">cluster.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#cluster-h"><span class="post-toc-number">34.</span> <span class="post-toc-text">cluster.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#config-c"><span class="post-toc-number">35.</span> <span class="post-toc-text">config.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#config-h"><span class="post-toc-number">36.</span> <span class="post-toc-text">config.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#connection-c"><span class="post-toc-number">37.</span> <span class="post-toc-text">connection.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#connection-h"><span class="post-toc-number">38.</span> <span class="post-toc-text">connection.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#connhelpers-h"><span class="post-toc-number">39.</span> <span class="post-toc-text">connhelpers.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#crc16-c"><span class="post-toc-number">40.</span> <span class="post-toc-text">crc16.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#crc16-slottable-h"><span class="post-toc-number">41.</span> <span class="post-toc-text">crc16_slottable.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#crc64-c"><span class="post-toc-number">42.</span> <span class="post-toc-text">crc64.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#crc64-h"><span class="post-toc-number">43.</span> <span class="post-toc-text">crc64.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#crcspeed-c"><span class="post-toc-number">44.</span> <span class="post-toc-text">crcspeed.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#crcspeed-h"><span class="post-toc-number">45.</span> <span class="post-toc-text">crcspeed.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#db-c"><span class="post-toc-number">46.</span> <span class="post-toc-text">db.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#debug-c"><span class="post-toc-number">47.</span> <span class="post-toc-text">debug.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#debugmacro-h"><span class="post-toc-number">48.</span> <span class="post-toc-text">debugmacro.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#defrag-c"><span class="post-toc-number">49.</span> <span class="post-toc-text">defrag.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#endianconv-c"><span class="post-toc-number">50.</span> <span class="post-toc-text">endianconv.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#endianconv-h"><span class="post-toc-number">51.</span> <span class="post-toc-text">endianconv.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#evict-c"><span class="post-toc-number">52.</span> <span class="post-toc-text">evict.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#expire-c"><span class="post-toc-number">53.</span> <span class="post-toc-text">expire.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#fmacros-h"><span class="post-toc-number">54.</span> <span class="post-toc-text">fmacros.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#geo-c"><span class="post-toc-number">55.</span> <span class="post-toc-text">geo.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#geo-h"><span class="post-toc-number">56.</span> <span class="post-toc-text">geo.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#geohash-c"><span class="post-toc-number">57.</span> <span class="post-toc-text">geohash.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#geohash-h"><span class="post-toc-number">58.</span> <span class="post-toc-text">geohash.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#geohash-helper-c"><span class="post-toc-number">59.</span> <span class="post-toc-text">geohash_helper.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#geohash-helper-h"><span class="post-toc-number">60.</span> <span class="post-toc-text">geohash_helper.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#help-h"><span class="post-toc-number">61.</span> <span class="post-toc-text">help.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#hyperloglog-c"><span class="post-toc-number">62.</span> <span class="post-toc-text">hyperloglog.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#latency-c"><span class="post-toc-number">63.</span> <span class="post-toc-text">latency.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#latency-h"><span class="post-toc-number">64.</span> <span class="post-toc-text">latency.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#lazyfree-c"><span class="post-toc-number">65.</span> <span class="post-toc-text">lazyfree.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#listpack-c"><span class="post-toc-number">66.</span> <span class="post-toc-text">listpack.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#listpack-h"><span class="post-toc-number">67.</span> <span class="post-toc-text">listpack.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#listpack-malloc-h"><span class="post-toc-number">68.</span> <span class="post-toc-text">listpack_malloc.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#localtime-c"><span class="post-toc-number">69.</span> <span class="post-toc-text">localtime.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#lolwut-c"><span class="post-toc-number">70.</span> <span class="post-toc-text">lolwut.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#lolwut-h"><span class="post-toc-number">71.</span> <span class="post-toc-text">lolwut.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#lolwut5-c"><span class="post-toc-number">72.</span> <span class="post-toc-text">lolwut5.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#lolwut6-c"><span class="post-toc-number">73.</span> <span class="post-toc-text">lolwut6.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#lzf-h"><span class="post-toc-number">74.</span> <span class="post-toc-text">lzf.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#lzfP-h"><span class="post-toc-number">75.</span> <span class="post-toc-text">lzfP.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#lzf-c-c"><span class="post-toc-number">76.</span> <span class="post-toc-text">lzf_c.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#lzf-d-c"><span class="post-toc-number">77.</span> <span class="post-toc-text">lzf_d.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#memtest-c"><span class="post-toc-number">78.</span> <span class="post-toc-text">memtest.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#mkreleasehdr-sh"><span class="post-toc-number">79.</span> <span class="post-toc-text">mkreleasehdr.sh</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#module-c"><span class="post-toc-number">80.</span> <span class="post-toc-text">module.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#modules"><span class="post-toc-number">81.</span> <span class="post-toc-text">modules</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#monotonic-c"><span class="post-toc-number">82.</span> <span class="post-toc-text">monotonic.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#monotonic-h"><span class="post-toc-number">83.</span> <span class="post-toc-text">monotonic.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#multi-c"><span class="post-toc-number">84.</span> <span class="post-toc-text">multi.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#networking-c"><span class="post-toc-number">85.</span> <span class="post-toc-text">networking.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#notify-c"><span class="post-toc-number">86.</span> <span class="post-toc-text">notify.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#object-c"><span class="post-toc-number">87.</span> <span class="post-toc-text">object.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#pqsort-c"><span class="post-toc-number">88.</span> <span class="post-toc-text">pqsort.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#pqsort-h"><span class="post-toc-number">89.</span> <span class="post-toc-text">pqsort.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#pubsub-c"><span class="post-toc-number">90.</span> <span class="post-toc-text">pubsub.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#quicklist-c"><span class="post-toc-number">91.</span> <span class="post-toc-text">quicklist.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#quicklist-h"><span class="post-toc-number">92.</span> <span class="post-toc-text">quicklist.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#rand-c"><span class="post-toc-number">93.</span> <span class="post-toc-text">rand.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#rand-h"><span class="post-toc-number">94.</span> <span class="post-toc-text">rand.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#rax-c"><span class="post-toc-number">95.</span> <span class="post-toc-text">rax.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#rax-h"><span class="post-toc-number">96.</span> <span class="post-toc-text">rax.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#rax-malloc-h"><span class="post-toc-number">97.</span> <span class="post-toc-text">rax_malloc.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#redis-benchmark-c"><span class="post-toc-number">98.</span> <span class="post-toc-text">redis-benchmark.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#redis-check-aof-c"><span class="post-toc-number">99.</span> <span class="post-toc-text">redis-check-aof.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#redis-check-rdb-c"><span class="post-toc-number">100.</span> <span class="post-toc-text">redis-check-rdb.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#redis-cli-c"><span class="post-toc-number">101.</span> <span class="post-toc-text">redis-cli.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#redis-trib-rb"><span class="post-toc-number">102.</span> <span class="post-toc-text">redis-trib.rb</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#redisassert-c"><span class="post-toc-number">103.</span> <span class="post-toc-text">redisassert.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#redisassert-h"><span class="post-toc-number">104.</span> <span class="post-toc-text">redisassert.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#redismodule-h"><span class="post-toc-number">105.</span> <span class="post-toc-text">redismodule.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#release-c"><span class="post-toc-number">106.</span> <span class="post-toc-text">release.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#replication-c"><span class="post-toc-number">107.</span> <span class="post-toc-text">replication.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#scripting-c"><span class="post-toc-number">108.</span> <span class="post-toc-text">scripting.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#sdsalloc-h"><span class="post-toc-number">109.</span> <span class="post-toc-text">sdsalloc.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#sentinel-c"><span class="post-toc-number">110.</span> <span class="post-toc-text">sentinel.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#server-c"><span class="post-toc-number">111.</span> <span class="post-toc-text">server.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#server-h"><span class="post-toc-number">112.</span> <span class="post-toc-text">server.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#setcpuaffinity-c"><span class="post-toc-number">113.</span> <span class="post-toc-text">setcpuaffinity.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#setproctitle-c"><span class="post-toc-number">114.</span> <span class="post-toc-text">setproctitle.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#sha1-c"><span class="post-toc-number">115.</span> <span class="post-toc-text">sha1.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#sha1-h"><span class="post-toc-number">116.</span> <span class="post-toc-text">sha1.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#sha256-c"><span class="post-toc-number">117.</span> <span class="post-toc-text">sha256.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#sha256-h"><span class="post-toc-number">118.</span> <span class="post-toc-text">sha256.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#siphash-c"><span class="post-toc-number">119.</span> <span class="post-toc-text">siphash.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#slowlog-c"><span class="post-toc-number">120.</span> <span class="post-toc-text">slowlog.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#slowlog-h"><span class="post-toc-number">121.</span> <span class="post-toc-text">slowlog.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#solarisfixes-h"><span class="post-toc-number">122.</span> <span class="post-toc-text">solarisfixes.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#sort-c"><span class="post-toc-number">123.</span> <span class="post-toc-text">sort.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#sparkline-c"><span class="post-toc-number">124.</span> <span class="post-toc-text">sparkline.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#sparkline-h"><span class="post-toc-number">125.</span> <span class="post-toc-text">sparkline.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#stream-h"><span class="post-toc-number">126.</span> <span class="post-toc-text">stream.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#syncio-c"><span class="post-toc-number">127.</span> <span class="post-toc-text">syncio.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#t-hash-c"><span class="post-toc-number">128.</span> <span class="post-toc-text">t_hash.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#t-list-c"><span class="post-toc-number">129.</span> <span class="post-toc-text">t_list.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#t-set-c"><span class="post-toc-number">130.</span> <span class="post-toc-text">t_set.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#t-stream-c"><span class="post-toc-number">131.</span> <span class="post-toc-text">t_stream.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#t-string-c"><span class="post-toc-number">132.</span> <span class="post-toc-text">t_string.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#t-zset-c"><span class="post-toc-number">133.</span> <span class="post-toc-text">t_zset.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#testhelp-h"><span class="post-toc-number">134.</span> <span class="post-toc-text">testhelp.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#timeout-c"><span class="post-toc-number">135.</span> <span class="post-toc-text">timeout.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#tls-c"><span class="post-toc-number">136.</span> <span class="post-toc-text">tls.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#tracking-c"><span class="post-toc-number">137.</span> <span class="post-toc-text">tracking.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#util-c"><span class="post-toc-number">138.</span> <span class="post-toc-text">util.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#util-h"><span class="post-toc-number">139.</span> <span class="post-toc-text">util.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#valgrind-sup"><span class="post-toc-number">140.</span> <span class="post-toc-text">valgrind.sup</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#version-h"><span class="post-toc-number">141.</span> <span class="post-toc-text">version.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#zipmap-c"><span class="post-toc-number">142.</span> <span class="post-toc-text">zipmap.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#zipmap-h"><span class="post-toc-number">143.</span> <span class="post-toc-text">zipmap.h</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#zmalloc-c"><span class="post-toc-number">144.</span> <span class="post-toc-text">zmalloc.c</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#zmalloc-h"><span class="post-toc-number">145.</span> <span class="post-toc-text">zmalloc.h</span></a></li></ol>
    </ul>
    




<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        
            <!-- Random Thumbnail -->
            <div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
            <script type="text/ls-javascript" id="post-thumbnail-script">
    var randomNum = Math.floor(Math.random() * 19 + 1);

    $('.post_thumbnail-random').attr('data-original', '/material/img/random/material-' + randomNum + '.png');
    $('.post_thumbnail-random').addClass('lazy');
</script>

        
    
            <p class="article-headline-p">
                redis源码
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/material/img/avatar.png" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>fightinggg</strong>
        <span>6月 26, 2021</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    

    <!-- Tags (bookmark) -->
    

    <!-- Share -->
    
        <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=redis源码&url=http://fightinggg.github.io/material/material/QVAQR0.html&pic=http://fightinggg.github.io/material/img/favicon.svg&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                分享到微博
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=redis源码&url=http://fightinggg.github.io/material/material/QVAQR0.html&via=fightinggg" target="_blank">
            <li class="mdl-menu__item">
                分享到 Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=http://fightinggg.github.io/material/material/QVAQR0.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    
        <a class="post_share-link" href="https://plus.google.com/share?url=http://fightinggg.github.io/material/material/QVAQR0.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Google+
            </li>
        </a>
    

    <!-- Share LinkedIn -->
    

    <!-- Share QQ -->
    

    <!-- Share Telegram -->
    
</ul>

    
</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <div><a href="/next/QVAQR0.html" style="border-bottom: 0px;border-bottom: 0px;
            background: #4FC921;
            color: white;
            border-radius: 5px;
            padding: 2px 6px 2px 6px;
            margin: 2px 6px 2px 6px;
            text-decoration: none;
            float: left;
            ">next</a><a href="/hexonext/QVAQR0.html" style="border-bottom: 0px;border-bottom: 0px;
            background: #4FC921;
            color: white;
            border-radius: 5px;
            padding: 2px 6px 2px 6px;
            margin: 2px 6px 2px 6px;
            text-decoration: none;
            float: left;
            ">hexonext</a><a href="/butterfly/QVAQR0.html" style="border-bottom: 0px;border-bottom: 0px;
            background: #4FC921;
            color: white;
            border-radius: 5px;
            padding: 2px 6px 2px 6px;
            margin: 2px 6px 2px 6px;
            text-decoration: none;
            float: left;
            ">butterfly</a><a href="/volantis/QVAQR0.html" style="border-bottom: 0px;border-bottom: 0px;
            background: #4FC921;
            color: white;
            border-radius: 5px;
            padding: 2px 6px 2px 6px;
            margin: 2px 6px 2px 6px;
            text-decoration: none;
            float: left;
            ">volantis</a><a href="/yearn/QVAQR0.html" style="border-bottom: 0px;border-bottom: 0px;
            background: #4FC921;
            color: white;
            border-radius: 5px;
            padding: 2px 6px 2px 6px;
            margin: 2px 6px 2px 6px;
            text-decoration: none;
            float: left;
            ">yearn</a><a href="/yilia/QVAQR0.html" style="border-bottom: 0px;border-bottom: 0px;
            background: #4FC921;
            color: white;
            border-radius: 5px;
            padding: 2px 6px 2px 6px;
            margin: 2px 6px 2px 6px;
            text-decoration: none;
            float: left;
            ">yilia</a><a href="/shoka/QVAQR0.html" style="border-bottom: 0px;border-bottom: 0px;
            background: #4FC921;
            color: white;
            border-radius: 5px;
            padding: 2px 6px 2px 6px;
            margin: 2px 6px 2px 6px;
            text-decoration: none;
            float: left;
            ">shoka</a><a href="/indigo/QVAQR0.html" style="border-bottom: 0px;border-bottom: 0px;
            background: #4FC921;
            color: white;
            border-radius: 5px;
            padding: 2px 6px 2px 6px;
            margin: 2px 6px 2px 6px;
            text-decoration: none;
            float: left;
            ">indigo</a><a href="/apollo/QVAQR0.html" style="border-bottom: 0px;border-bottom: 0px;
            background: #4FC921;
            color: white;
            border-radius: 5px;
            padding: 2px 6px 2px 6px;
            margin: 2px 6px 2px 6px;
            text-decoration: none;
            float: left;
            ">apollo</a><a href="/landscape/QVAQR0.html" style="border-bottom: 0px;border-bottom: 0px;
            background: #4FC921;
            color: white;
            border-radius: 5px;
            padding: 2px 6px 2px 6px;
            margin: 2px 6px 2px 6px;
            text-decoration: none;
            float: left;
            ">landscape</a><a href="/cactus/QVAQR0.html" style="border-bottom: 0px;border-bottom: 0px;
            background: #4FC921;
            color: white;
            border-radius: 5px;
            padding: 2px 6px 2px 6px;
            margin: 2px 6px 2px 6px;
            text-decoration: none;
            float: left;
            ">cactus</a><a href="/matery/QVAQR0.html" style="border-bottom: 0px;border-bottom: 0px;
            background: #4FC921;
            color: white;
            border-radius: 5px;
            padding: 2px 6px 2px 6px;
            margin: 2px 6px 2px 6px;
            text-decoration: none;
            float: left;
            ">matery</a><a href="/icarus/QVAQR0.html" style="border-bottom: 0px;border-bottom: 0px;
            background: #4FC921;
            color: white;
            border-radius: 5px;
            padding: 2px 6px 2px 6px;
            margin: 2px 6px 2px 6px;
            text-decoration: none;
            float: left;
            ">icarus</a><a href="/fluid/QVAQR0.html" style="border-bottom: 0px;border-bottom: 0px;
            background: #4FC921;
            color: white;
            border-radius: 5px;
            padding: 2px 6px 2px 6px;
            margin: 2px 6px 2px 6px;
            text-decoration: none;
            float: left;
            ">fluid</a><a href="/material/QVAQR0.html" style="border-bottom: 0px;border-bottom: 0px;
            background: #4FC921;
            color: white;
            border-radius: 5px;
            padding: 2px 6px 2px 6px;
            margin: 2px 6px 2px 6px;
            text-decoration: none;
            float: left;
            ">material</a><div style="clear: both;"></div></div>



<h1 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h1><p>使用6.2.4</p>
<h1 id="sds-h-sds-c"><a href="#sds-h-sds-c" class="headerlink" title="sds.h sds.c"></a>sds.h sds.c</h1><h2 id="内存对齐"><a href="#内存对齐" class="headerlink" title="内存对齐"></a>内存对齐</h2><p><code>__attribute__((__packed__))</code>可以让编译器对结构体不进行内存对齐，<a target="_blank" rel="noopener" href="https://blog.csdn.net/wuxing26jiayou/article/details/79609025">详细参考</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span>((__<span class="title">packed__</span>)) <span class="title">sdshdr64</span> &#123;</span></span><br><span class="line">    <span class="type">uint64_t</span> len;        <span class="comment">/* used */</span></span><br><span class="line">    <span class="type">uint64_t</span> alloc;      <span class="comment">/* excluding the header and null terminator */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> flags; <span class="comment">/* 3 lsb of type, 5 unused bits */</span></span><br><span class="line">    <span class="type">char</span> buf[];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">sdshdr64</span> &#123;</span></span><br><span class="line">    <span class="type">uint64_t</span> len;        <span class="comment">/* used */</span></span><br><span class="line">    <span class="type">uint64_t</span> alloc;      <span class="comment">/* excluding the header and null terminator */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> flags; <span class="comment">/* 3 lsb of type, 5 unused bits */</span></span><br><span class="line">    <span class="type">char</span> buf[];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;packed: %d\n&quot;</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> sdshdr64));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;nopacked: %d\n&quot;</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> _sdshdr64));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">gcc a.c -o a &amp;&amp; ./a</span></span><br><span class="line"><span class="comment">packed: 17</span></span><br><span class="line"><span class="comment">nopacked: 24</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h2 id="宏"><a href="#宏" class="headerlink" title="宏##"></a>宏##</h2><p>##后标识的字符串会被替换，然后其左右的内容加上自己会被合并到一起，编译器将其视为标识符进行解析，<a target="_blank" rel="noopener" href="https://blog.csdn.net/mitu405687908/article/details/51084441?utm_medium=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromMachineLearnPai2~default-2.control&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromMachineLearnPai2~default-2.control">详细参考</a></p>
<span id="more"></span>

<h2 id="sds-h-源码"><a href="#sds-h-源码" class="headerlink" title="sds.h 源码"></a>sds.h 源码</h2><p><code>sds</code> 可以被简单的认为是一个 <code>char*</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="type">char</span> *sds;</span><br></pre></td></tr></table></figure>

<p>接下来是5种 <code>sds</code> 他们是<code>sdshdr5</code>, <code>sdshdr8</code>, <code>sdshdr16</code>, <code>sdshdr32</code>, <code>sdshdr64</code>, 分别可以储存长度为$2^5$, $2^8$, $2^{16}$, $2^{32}$, $2^{64}$ 的字符串。</p>
<p><code>__attribute__ ((__packed__))</code>是编译器指令，可以取消内存对齐，让内存紧凑排列，这部分首先看后四个结构体，他们的内存结构定义几乎一摸一样。</p>
<ul>
<li><p>len: 字符串的长度</p>
</li>
<li><p>alloc： 分配的空间大小</p>
</li>
<li><p>flags： 字符串的类型（5种），所以只有最低的三位有意义，高5位不做使用。</p>
</li>
<li><p>buf： 字符串的实际内容</p>
</li>
</ul>
<p>对于<code>sdshdr5</code>,他比较特殊，实际上他的len和alloc一定相等，并储存于flags的高5位上，借此实现了内存压缩。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Note: sdshdr5 is never used, we just access the flags byte directly.</span></span><br><span class="line"><span class="comment"> * However is here to document the layout of type 5 SDS strings. */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">sdshdr5</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> flags; <span class="comment">/* 3 lsb of type, and 5 msb of string length */</span></span><br><span class="line">    <span class="type">char</span> buf[];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">sdshdr8</span> &#123;</span></span><br><span class="line">    <span class="type">uint8_t</span> len; <span class="comment">/* used */</span></span><br><span class="line">    <span class="type">uint8_t</span> alloc; <span class="comment">/* excluding the header and null terminator */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> flags; <span class="comment">/* 3 lsb of type, 5 unused bits */</span></span><br><span class="line">    <span class="type">char</span> buf[];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">sdshdr16</span> &#123;</span></span><br><span class="line">    <span class="type">uint16_t</span> len; <span class="comment">/* used */</span></span><br><span class="line">    <span class="type">uint16_t</span> alloc; <span class="comment">/* excluding the header and null terminator */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> flags; <span class="comment">/* 3 lsb of type, 5 unused bits */</span></span><br><span class="line">    <span class="type">char</span> buf[];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">sdshdr32</span> &#123;</span></span><br><span class="line">    <span class="type">uint32_t</span> len; <span class="comment">/* used */</span></span><br><span class="line">    <span class="type">uint32_t</span> alloc; <span class="comment">/* excluding the header and null terminator */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> flags; <span class="comment">/* 3 lsb of type, 5 unused bits */</span></span><br><span class="line">    <span class="type">char</span> buf[];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">sdshdr64</span> &#123;</span></span><br><span class="line">    <span class="type">uint64_t</span> len; <span class="comment">/* used */</span></span><br><span class="line">    <span class="type">uint64_t</span> alloc; <span class="comment">/* excluding the header and null terminator */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> flags; <span class="comment">/* 3 lsb of type, 5 unused bits */</span></span><br><span class="line">    <span class="type">char</span> buf[];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>sds 把字符串的内容，以及他的元信息（字符串类型、字符串长度、字符串分配的空间）储存在了一起，让内存排列更加紧致。</p>
<h1 id="adlist-c-adlist-h"><a href="#adlist-c-adlist-h" class="headerlink" title="adlist.c adlist.h"></a>adlist.c adlist.h</h1><p>很普通的链表，并没有什么很特殊的地方，注意<code>listIter</code>的<code>direction</code>是迭代器的方向。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">listNode</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">listNode</span> *<span class="title">prev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">listNode</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="type">void</span> *value;</span><br><span class="line">&#125; listNode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">listIter</span> &#123;</span></span><br><span class="line">    listNode *next;</span><br><span class="line">    <span class="type">int</span> direction;</span><br><span class="line">&#125; listIter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">list</span> &#123;</span></span><br><span class="line">    listNode *head;</span><br><span class="line">    listNode *tail;</span><br><span class="line">    <span class="type">void</span> *(*dup)(<span class="type">void</span> *ptr);</span><br><span class="line">    <span class="type">void</span> (*<span class="built_in">free</span>)(<span class="type">void</span> *ptr);</span><br><span class="line">    <span class="type">int</span> (*match)(<span class="type">void</span> *ptr, <span class="type">void</span> *key);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> len;</span><br><span class="line">&#125; <span class="built_in">list</span>;</span><br></pre></td></tr></table></figure>



<h1 id="mt19937-64-c-mt19937-64-h"><a href="#mt19937-64-c-mt19937-64-h" class="headerlink" title="mt19937-64.c mt19937-64.h"></a>mt19937-64.c mt19937-64.h</h1><h2 id="梅森素数"><a href="#梅森素数" class="headerlink" title="梅森素数"></a>梅森素数</h2><p>在OEIS上，梅森素数有<a target="_blank" rel="noopener" href="https://oeis.org/A000043/list">这些</a>, 维基百科上也有<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%A2%85%E6%A3%AE%E7%B4%A0%E6%95%B0#%E6%A2%85%E6%A3%AE%E7%B4%A0%E6%95%B0%E5%88%97%E8%A1%A8">说明</a>, 我们需要注意到的是$2^{19937}-1$是一个梅森素数</p>
<h2 id="线性反馈移位寄存器"><a href="#线性反馈移位寄存器" class="headerlink" title="线性反馈移位寄存器"></a>线性反馈移位寄存器</h2><p>线性反馈移位寄存器（Linear Feedback Shifting Register，简称 LFSR）</p>
<p>假设你有一个寄存器，寄存器中储存着一些二进制位，寄存器中有几个位被标记了，接下来会有无限轮操作，每轮操作如下</p>
<ul>
<li>寄存器输出最低位x（x&#x3D;0或1）。</li>
<li>寄存器选择被标记的位和x，取出其值，放到一起进行异或，得到y（y&#x3D;0或1）。</li>
<li>寄存器把自己右移1位，然后把值y放入最高位。</li>
</ul>
<p>具体来说，你有一个$8$位寄存器，初始储存着$00001111$，其中$3$,$5$,$7$位被标记了，于是开始操作。</p>
<p>第一轮输出$x&#x3D;1$，然后从低位到高位选择了$1$,$0$,$0$, 最后$y&#x3D;1 \oplus1 \oplus 0 \oplus 0&#x3D;0$，寄存器变成了$00000111$</p>
<p>第二轮输出$x&#x3D;1$，然后从低位到高位选择了$1$,$0$,$0$, 最后$y&#x3D;1 \oplus1 \oplus 0 \oplus 0&#x3D;0$，寄存器变成了$00000011$</p>
<p>第三轮输出$x&#x3D;1$，然后从低位到高位选择了$0$,$0$,$0$, 最后$y&#x3D;1 \oplus 0 \oplus 0 \oplus 0&#x3D;1$，寄存器变成了$10000001$</p>
<p>第四轮输出$x&#x3D;1$，然后从低位到高位选择了$0$,$0$,$0$, 最后$y&#x3D;1 \oplus 0 \oplus 0 \oplus 0&#x3D;1$，寄存器变成了$11000000$</p>
<p>第五轮输出$x&#x3D;0$，然后从低位到高位选择了$0$,$0$,$1$, 最后$y&#x3D;0 \oplus 0 \oplus 0 \oplus 1&#x3D;1$，寄存器变成了$11100000$</p>
<p>……</p>
<h2 id="梅森旋转算法"><a href="#梅森旋转算法" class="headerlink" title="梅森旋转算法"></a>梅森旋转算法</h2><p>这是一个随机数生成算法，这里有一篇有趣的<a target="_blank" rel="noopener" href="https://liam.page/2018/01/12/Mersenne-twister/">Blog</a>，有兴趣可以读一下。这里引用一些主要内容。</p>
<p>梅森旋转算法（Mersenne Twister Algorithm，简称 MT）</p>
<blockquote>
<p>$32$ 位的梅森旋转算法能够产生周期为 $P$ 的 $w$-比特的随机数序列${\vec x_i}$；其中 $w&#x3D;32$。这也就是说，每一个$\vec x$ 是一个长度为 $32$ 的行向量，并且其中的每一个元素都是二元数域$\mathbb{F}_2 \overset{\text{def}}{&#x3D;} {0, 1}$中的元素。现在，我们定义如下一些记号，来描述梅森旋转算法是如何进行旋转（线性移位）的。</p>
<ul>
<li>$n$：参与梅森旋转的随机数个数；</li>
<li>$r$：$[0, w)$ 之间的整数；</li>
<li>$m$：$(0, n]$之间的整数；</li>
<li>$\mathbf{A}$：$w \times w$ 的常矩阵；</li>
<li>$\vec x^{(u)}$：$\vec x$的最高 $w - r$ 比特组成的数（低位补零）；</li>
<li>$\vec x^{(l)}$：$\vec x$的最低 r 比特组成的数（高位补零）。</li>
</ul>
<p>梅森旋转算法，首先需要根据随机数种子初始化$ n $个行向量：<br>$$<br>\vec x_0, \vec x_1, \ldots, \vec x_{n - 1}.<br>$$<br>而后根据下式，从$ k&#x3D;0$ 开始依次计算 $\vec x_{n}$：<br>$$<br>\begin{equation}\vec x_{k + n} \overset{\text{def}}{&#x3D;} \vec x_{k + m}\oplus \bigl(\vec x_{k}^{(u)}\mid \vec x_{k + 1}^{(l)}\bigr)\mathbf{A}.\label{eq:twister}\end{equation}<br>$$</p>
<p>其中，$\vec x\mid \vec x’$表示两个二进制数按位或；$\vec x\oplus \vec x’$表示两个二进制数按位半加（不进位，也就是按位异或）；$\vec x\mathbf A$ 则表示按位半加的矩阵乘法。在 MT 中，$\mathbf A$ 被定义为<br>$$<br>\begin{pmatrix}<br>&amp; 1 \<br>&amp; &amp; 1 \<br>&amp; &amp; &amp; \ddots \<br>&amp; &amp; &amp; &amp; 1 \<br>a_{w - 1} &amp; a_{w - 2} &amp; a_{w - 3} &amp; \cdots &amp; a_0<br>\end{pmatrix}<br>$$</p>
</blockquote>
<p>我们现在看看这个计算和旋转有什么关系。首先不考虑矩阵$\mathbf A$.</p>
<p>则有$\vec x_{k + n} \overset{\text{def}}{&#x3D;} \vec x_{k + m}\oplus \bigl(\vec x_{k}^{(u)}\mid \vec x_{k + 1}^{(l)}\bigr)$, 这个式子笔者看了很久才明白他就是$w$轮线性反馈移位寄存器变换。下图是计算$x_n$的时候的异或情况， 可以看到$x_n$的每一个位都是独立的异或</p>
<p><img src='/https://raw.githubusercontent.com/fightinggg/drawio-data/master/redis-src/redis-src-mt19937.svg'></img></p>
<blockquote>
<p>回过头来看 2 式，不难发现，这其实相当于一个 $nw - r$ 级的线性反馈移位寄存器（取 $\vec x_k^{(u)}$的最高 $w−r$ 位与 $\vec x_{k + 1}^{(l)}$的最低 $r $位进行迭代异或，再经过一个不影响周期的线性变换 $\mathbf A$）。只不过，2 式每一次运算，相当于 $LFSR$ 进行了 $w$ 轮计算。若 $w$ 与 $nw−r$ 互素，那么这一微小的改变是不会影响 $LFSR$ 的周期的。考虑到 $LFSR$ 的计算过程像是在「旋转」，这即是「梅森『旋转』」名字的来由。</p>
</blockquote>
<h2 id="mt19937源码"><a href="#mt19937源码" class="headerlink" title="mt19937源码"></a>mt19937源码</h2><p>主要的计算都在这里</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="title function_">genrand64_int64</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;NN-MM;i++) &#123;</span><br><span class="line">        x = (mt[i]&amp;UM)|(mt[i+<span class="number">1</span>]&amp;LM);</span><br><span class="line">        mt[i] = mt[i+MM] ^ (x&gt;&gt;<span class="number">1</span>) ^ mag01[(<span class="type">int</span>)(x&amp;<span class="number">1ULL</span>)];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (;i&lt;NN<span class="number">-1</span>;i++) &#123;</span><br><span class="line">        x = (mt[i]&amp;UM)|(mt[i+<span class="number">1</span>]&amp;LM);</span><br><span class="line">        mt[i] = mt[i+(MM-NN)] ^ (x&gt;&gt;<span class="number">1</span>) ^ mag01[(<span class="type">int</span>)(x&amp;<span class="number">1ULL</span>)];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后是<code>63</code>位生成</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* generates a random number on [0, 2^63-1]-interval */</span></span><br><span class="line"><span class="type">long</span> <span class="type">long</span> <span class="title function_">genrand64_int63</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">long</span> <span class="type">long</span>)(genrand64_int64() &gt;&gt; <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实数的生成</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* generates a random number on [0,1]-real-interval */</span></span><br><span class="line"><span class="type">double</span> <span class="title function_">genrand64_real1</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> (genrand64_int64() &gt;&gt; <span class="number">11</span>) * (<span class="number">1.0</span>/<span class="number">9007199254740991.0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* generates a random number on [0,1)-real-interval */</span></span><br><span class="line"><span class="type">double</span> <span class="title function_">genrand64_real2</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> (genrand64_int64() &gt;&gt; <span class="number">11</span>) * (<span class="number">1.0</span>/<span class="number">9007199254740992.0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* generates a random number on (0,1)-real-interval */</span></span><br><span class="line"><span class="type">double</span> <span class="title function_">genrand64_real3</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> ((genrand64_int64() &gt;&gt; <span class="number">12</span>) + <span class="number">0.5</span>) * (<span class="number">1.0</span>/<span class="number">4503599627370496.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h1 id="dict-c-dict-h"><a href="#dict-c-dict-h" class="headerlink" title="dict.c dict.h"></a>dict.c dict.h</h1><h2 id="字典源码"><a href="#字典源码" class="headerlink" title="字典源码"></a>字典源码</h2><p>字典结构体定义，需要注意这里有两个dictht，即两个字典，这涉及到了一个重hash问题，redis使用了渐进式rehash算法，即把重hash分布到各个地方(插入、查询等)，使得重hash的复杂度降低为$O1$，</p>
<p>redis是单线程，绝对不能出现过于耗时的操作，否则影响redis延时</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dict</span> &#123;</span></span><br><span class="line">    dictType *type;</span><br><span class="line">    <span class="type">void</span> *privdata;</span><br><span class="line">    dictht ht[<span class="number">2</span>];</span><br><span class="line">    <span class="type">long</span> rehashidx; <span class="comment">/* rehashing not in progress if rehashidx == -1 */</span></span><br><span class="line">    <span class="type">int16_t</span> pauserehash; <span class="comment">/* If &gt;0 rehashing is paused (&lt;0 indicates coding error) */</span></span><br><span class="line">&#125; dict;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="server-h-server-c-1-跳表"><a href="#server-h-server-c-1-跳表" class="headerlink" title="server.h server.c-1-跳表"></a>server.h server.c-1-跳表</h1><p>跳表定义在这里</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ZSETs use a specialized version of Skiplists */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> &#123;</span></span><br><span class="line">    sds ele;</span><br><span class="line">    <span class="type">double</span> score;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> *<span class="title">backward</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistLevel</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> *<span class="title">forward</span>;</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> span;</span><br><span class="line">    &#125; level[];</span><br><span class="line">&#125; zskiplistNode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">zskiplist</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> *<span class="title">header</span>, *<span class="title">tail</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> length;</span><br><span class="line">    <span class="type">int</span> level;</span><br><span class="line">&#125; zskiplist;</span><br></pre></td></tr></table></figure>



<h1 id="intset-c-intset-h"><a href="#intset-c-intset-h" class="headerlink" title="intset.c intset.h"></a>intset.c intset.h</h1><p>整数集合，这里可以储存整数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">intset</span> &#123;</span></span><br><span class="line">    <span class="type">uint32_t</span> encoding;</span><br><span class="line">    <span class="type">uint32_t</span> length;</span><br><span class="line">    <span class="type">int8_t</span> contents[];</span><br><span class="line">&#125; intset;</span><br><span class="line"></span><br><span class="line">intset *<span class="title function_">intsetNew</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line">intset *<span class="title function_">intsetAdd</span><span class="params">(intset *is, <span class="type">int64_t</span> value, <span class="type">uint8_t</span> *success)</span>;</span><br><span class="line">intset *<span class="title function_">intsetRemove</span><span class="params">(intset *is, <span class="type">int64_t</span> value, <span class="type">int</span> *success)</span>;</span><br><span class="line"><span class="type">uint8_t</span> <span class="title function_">intsetFind</span><span class="params">(intset *is, <span class="type">int64_t</span> value)</span>;</span><br><span class="line"><span class="type">int64_t</span> <span class="title function_">intsetRandom</span><span class="params">(intset *is)</span>;</span><br><span class="line"><span class="type">uint8_t</span> <span class="title function_">intsetGet</span><span class="params">(intset *is, <span class="type">uint32_t</span> pos, <span class="type">int64_t</span> *value)</span>;</span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">intsetLen</span><span class="params">(<span class="type">const</span> intset *is)</span>;</span><br><span class="line"><span class="type">size_t</span> <span class="title function_">intsetBlobLen</span><span class="params">(intset *is)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">intsetValidateIntegrity</span><span class="params">(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *is, <span class="type">size_t</span> size, <span class="type">int</span> deep)</span>;</span><br></pre></td></tr></table></figure>

<p>encoding是编码方式，指的是contents中的数据如何储存，编码方式分为三种</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Note that these encodings are ordered, so:</span></span><br><span class="line"><span class="comment"> * INTSET_ENC_INT16 &lt; INTSET_ENC_INT32 &lt; INTSET_ENC_INT64. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INTSET_ENC_INT16 (sizeof(int16_t))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INTSET_ENC_INT32 (sizeof(int32_t))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INTSET_ENC_INT64 (sizeof(int64_t))</span></span><br></pre></td></tr></table></figure>

<p>length是数字的个数</p>
<p>contents是内容，但是他不一定是8位的整数，取决于encoding的值。</p>
<h2 id="整数集合升级"><a href="#整数集合升级" class="headerlink" title="整数集合升级"></a>整数集合升级</h2><p>由于整数集合初始情况储存的是INTSET_ENC_INT16，当你插入一个32位的数字以后，会出现溢出，这时候就需要进行升级，就直接开辟新的空间然后拷贝过去，复杂的$O(N)$</p>
<p>不支持降级</p>
<h1 id="ziplist-c-ziplist-h"><a href="#ziplist-c-ziplist-h" class="headerlink" title="ziplist.c ziplist.h"></a>ziplist.c ziplist.h</h1><p>压缩列表</p>
<h1 id="server-h-server-c-2-对象"><a href="#server-h-server-c-2-对象" class="headerlink" title="server.h server.c-2-对象"></a>server.h server.c-2-对象</h1><p>redis对象都在这里统一起来</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">redisObject</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> type:<span class="number">4</span>;</span><br><span class="line">    <span class="type">unsigned</span> encoding:<span class="number">4</span>;</span><br><span class="line">    <span class="type">unsigned</span> lru:LRU_BITS; <span class="comment">/* LRU time (relative to global lru_clock) or</span></span><br><span class="line"><span class="comment">                            * LFU data (least significant 8 bits frequency</span></span><br><span class="line"><span class="comment">                            * and most significant 16 bits access time). */</span></span><br><span class="line">    <span class="type">int</span> refcount;</span><br><span class="line">    <span class="type">void</span> *ptr;</span><br><span class="line">&#125; robj;</span><br></pre></td></tr></table></figure>



<h1 id="server-h-3-db"><a href="#server-h-3-db" class="headerlink" title="server.h-3-db"></a>server.h-3-db</h1><p>这次主要关注redisServer，这个结构体有460行，笔者省去了一些,可以砍刀redisDb是一个数组，dbnum记录他的数量，一般情况下，dbnum为6</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisServer</span> &#123;</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    redisDb *db;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="type">int</span> dbnum;                      <span class="comment">/* Total number of configured DBs */</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>然后是客户端这边, 注意到client,. 这里也有一个指针，当然他指向的就是当前使用的db，而不是数组。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">client</span> &#123;</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    redisDb *db;            <span class="comment">/* Pointer to currently SELECTed DB. */</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125; client;</span><br></pre></td></tr></table></figure>

<p>看完服务器和客户端，然后看db</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Redis database representation. There are multiple databases identified</span></span><br><span class="line"><span class="comment"> * by integers from 0 (the default database) up to the max configured</span></span><br><span class="line"><span class="comment"> * database. The database number is the &#x27;id&#x27; field in the structure. */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">redisDb</span> &#123;</span></span><br><span class="line">    dict *dict;                 <span class="comment">/* The keyspace for this DB */</span></span><br><span class="line">    dict *expires;              <span class="comment">/* Timeout of keys with a timeout set */</span></span><br><span class="line">    dict *blocking_keys;        <span class="comment">/* Keys with clients waiting for data (BLPOP)*/</span></span><br><span class="line">    dict *ready_keys;           <span class="comment">/* Blocked keys that received a PUSH */</span></span><br><span class="line">    dict *watched_keys;         <span class="comment">/* WATCHED keys for MULTI/EXEC CAS */</span></span><br><span class="line">    <span class="type">int</span> id;                     <span class="comment">/* Database ID */</span></span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> avg_ttl;          <span class="comment">/* Average TTL, just for stats */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> expires_cursor; <span class="comment">/* Cursor of the active expire cycle. */</span></span><br><span class="line">    <span class="built_in">list</span> *defrag_later;         <span class="comment">/* List of key names to attempt to defrag one by one, gradually. */</span></span><br><span class="line">&#125; redisDb;</span><br></pre></td></tr></table></figure>

<p>对于redisDb，笔者这里引用一下《Redis设计与实现》中的一个图，读者可以看的更加清晰</p>
<blockquote>
<p><img src='/image-2021-06-30-16.09.00.000.png'></img></p>
</blockquote>
<h1 id="rio-c-rio-h"><a href="#rio-c-rio-h" class="headerlink" title="rio.c rio.h"></a>rio.c rio.h</h1><p>rio即redis io， 主要实现了redis中的io操作, rio是一个结构体，他就是<code>_rio</code>, 下面是源码。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">rio</span> &#123;</span></span><br><span class="line">    <span class="comment">/* Backend functions.</span></span><br><span class="line"><span class="comment">     * Since this functions do not tolerate short writes or reads the return</span></span><br><span class="line"><span class="comment">     * value is simplified to: zero on error, non zero on complete success. */</span></span><br><span class="line">    <span class="type">size_t</span> (*read)(<span class="keyword">struct</span> _rio *, <span class="type">void</span> *buf, <span class="type">size_t</span> len);</span><br><span class="line">    <span class="type">size_t</span> (*write)(<span class="keyword">struct</span> _rio *, <span class="type">const</span> <span class="type">void</span> *buf, <span class="type">size_t</span> len);</span><br><span class="line">    <span class="type">off_t</span> (*tell)(<span class="keyword">struct</span> _rio *);</span><br><span class="line">    <span class="type">int</span> (*flush)(<span class="keyword">struct</span> _rio *);</span><br><span class="line">    <span class="comment">/* The update_cksum method if not NULL is used to compute the checksum of</span></span><br><span class="line"><span class="comment">     * all the data that was read or written so far. The method should be</span></span><br><span class="line"><span class="comment">     * designed so that can be called with the current checksum, and the buf</span></span><br><span class="line"><span class="comment">     * and len fields pointing to the new block of data to add to the checksum</span></span><br><span class="line"><span class="comment">     * computation. */</span></span><br><span class="line">    <span class="type">void</span> (*update_cksum)(<span class="keyword">struct</span> _rio *, <span class="type">const</span> <span class="type">void</span> *buf, <span class="type">size_t</span> len);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* The current checksum and flags (see RIO_FLAG_*) */</span></span><br><span class="line">    <span class="type">uint64_t</span> cksum, flags;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* number of bytes read or written */</span></span><br><span class="line">    <span class="type">size_t</span> processed_bytes;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* maximum single read or write chunk size */</span></span><br><span class="line">    <span class="type">size_t</span> max_processing_chunk;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Backend-specific vars. */</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="comment">/* In-memory buffer target. */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            sds ptr;</span><br><span class="line">            <span class="type">off_t</span> pos;</span><br><span class="line">        &#125; buffer;</span><br><span class="line">        <span class="comment">/* Stdio file pointer target. */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            FILE *fp;</span><br><span class="line">            <span class="type">off_t</span> buffered; <span class="comment">/* Bytes written since last fsync. */</span></span><br><span class="line">            <span class="type">off_t</span> autosync; <span class="comment">/* fsync after &#x27;autosync&#x27; bytes written. */</span></span><br><span class="line">        &#125; file;</span><br><span class="line">        <span class="comment">/* Connection object (used to read from socket) */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            connection *conn;   <span class="comment">/* Connection */</span></span><br><span class="line">            <span class="type">off_t</span> pos;    <span class="comment">/* pos in buf that was returned */</span></span><br><span class="line">            sds buf;      <span class="comment">/* buffered data */</span></span><br><span class="line">            <span class="type">size_t</span> read_limit;  <span class="comment">/* don&#x27;t allow to buffer/read more than that */</span></span><br><span class="line">            <span class="type">size_t</span> read_so_far; <span class="comment">/* amount of data read from the rio (not buffered) */</span></span><br><span class="line">        &#125; conn;</span><br><span class="line">        <span class="comment">/* FD target (used to write to pipe). */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            <span class="type">int</span> fd;       <span class="comment">/* File descriptor. */</span></span><br><span class="line">            <span class="type">off_t</span> pos;</span><br><span class="line">            sds buf;</span><br><span class="line">        &#125; fd;</span><br><span class="line">    &#125; io;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>简单来说，他的这些字段，分别对应这些内容：</p>
<table>
<thead>
<tr>
<th align="center">字段</th>
<th align="center">内容</th>
</tr>
</thead>
<tbody><tr>
<td align="center">read</td>
<td align="center">读数据，是函数指针</td>
</tr>
<tr>
<td align="center">write</td>
<td align="center">写数据，是函数指针</td>
</tr>
<tr>
<td align="center">tell</td>
<td align="center">tell，是函数指针</td>
</tr>
<tr>
<td align="center">flush</td>
<td align="center">flush，是函数指针</td>
</tr>
<tr>
<td align="center">update_cksum</td>
<td align="center">校验和，是函数指针</td>
</tr>
<tr>
<td align="center">cksum</td>
<td align="center">当前校验和</td>
</tr>
<tr>
<td align="center">flags</td>
<td align="center">是否发生读写错误</td>
</tr>
<tr>
<td align="center">processed_bytes</td>
<td align="center">已经处理的字节数</td>
</tr>
<tr>
<td align="center">max_processing_chunk</td>
<td align="center">单次最大处理的字节数</td>
</tr>
<tr>
<td align="center">io</td>
<td align="center">具体的读写目标</td>
</tr>
</tbody></table>
<p>这里的函数指针主要作用是给后面的下面这些函数使用，这种编程方式有一点像面向对象中的抽象类。注意看，下面的<code>rioWrite</code>使用了对象<code>r</code>的<code>write</code>方法，实现了任意 长度<code>len</code>的写入。而对象<code>r</code>的<code>write</code>方法是不支持任意长度len的。<code>rioRead</code>也是同理了。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">size_t</span> <span class="title function_">rioWrite</span><span class="params">(rio *r, <span class="type">const</span> <span class="type">void</span> *buf, <span class="type">size_t</span> len)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (r-&gt;flags &amp; RIO_FLAG_WRITE_ERROR) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (len) &#123;</span><br><span class="line">        <span class="type">size_t</span> bytes_to_write = (r-&gt;max_processing_chunk &amp;&amp; r-&gt;max_processing_chunk &lt; len) ? r-&gt;max_processing_chunk : len;</span><br><span class="line">        <span class="keyword">if</span> (r-&gt;update_cksum) r-&gt;update_cksum(r,buf,bytes_to_write);</span><br><span class="line">        <span class="keyword">if</span> (r-&gt;write(r,buf,bytes_to_write) == <span class="number">0</span>) &#123;</span><br><span class="line">            r-&gt;flags |= RIO_FLAG_WRITE_ERROR;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        buf = (<span class="type">char</span>*)buf + bytes_to_write;</span><br><span class="line">        len -= bytes_to_write;</span><br><span class="line">        r-&gt;processed_bytes += bytes_to_write;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">size_t</span> <span class="title function_">rioRead</span><span class="params">(rio *r, <span class="type">void</span> *buf, <span class="type">size_t</span> len)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (r-&gt;flags &amp; RIO_FLAG_READ_ERROR) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (len) &#123;</span><br><span class="line">        <span class="type">size_t</span> bytes_to_read = (r-&gt;max_processing_chunk &amp;&amp; r-&gt;max_processing_chunk &lt; len) ? r-&gt;max_processing_chunk : len;</span><br><span class="line">        <span class="keyword">if</span> (r-&gt;read(r,buf,bytes_to_read) == <span class="number">0</span>) &#123;</span><br><span class="line">            r-&gt;flags |= RIO_FLAG_READ_ERROR;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r-&gt;update_cksum) r-&gt;update_cksum(r,buf,bytes_to_read);</span><br><span class="line">        buf = (<span class="type">char</span>*)buf + bytes_to_read;</span><br><span class="line">        len -= bytes_to_read;</span><br><span class="line">        r-&gt;processed_bytes += bytes_to_read;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">off_t</span> <span class="title function_">rioTell</span><span class="params">(rio *r)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> r-&gt;tell(r);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> <span class="title function_">rioFlush</span><span class="params">(rio *r)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> r-&gt;flush(r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里有一个有趣的函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Flushes any buffer to target device if applicable. Returns 1 on success</span></span><br><span class="line"><span class="comment"> * and 0 on failures. */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">rioBufferFlush</span><span class="params">(rio *r)</span> &#123;</span><br><span class="line">    UNUSED(r);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>; <span class="comment">/* Nothing to do, our write just appends to the buffer. */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中的<code>UNUSED</code>来自于一个宏<code> #define UNUSED(V) ((void) V)</code>, 其作用是消除编译器的警告： 变量未使用。</p>
<p>最后是整个<code>bufferio</code>的源码, 定义了一些函数，这些函数只给rioBufferIO这个对象使用。这是一种单例模式。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ------------------------- Buffer I/O implementation ----------------------- */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Returns 1 or 0 for success/failure. */</span></span><br><span class="line"><span class="type">static</span> <span class="type">size_t</span> <span class="title function_">rioBufferWrite</span><span class="params">(rio *r, <span class="type">const</span> <span class="type">void</span> *buf, <span class="type">size_t</span> len)</span> &#123;</span><br><span class="line">    r-&gt;io.buffer.ptr = sdscatlen(r-&gt;io.buffer.ptr,(<span class="type">char</span>*)buf,len);</span><br><span class="line">    r-&gt;io.buffer.pos += len;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Returns 1 or 0 for success/failure. */</span></span><br><span class="line"><span class="type">static</span> <span class="type">size_t</span> <span class="title function_">rioBufferRead</span><span class="params">(rio *r, <span class="type">void</span> *buf, <span class="type">size_t</span> len)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (sdslen(r-&gt;io.buffer.ptr)-r-&gt;io.buffer.pos &lt; len)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">/* not enough buffer to return len bytes. */</span></span><br><span class="line">    <span class="built_in">memcpy</span>(buf,r-&gt;io.buffer.ptr+r-&gt;io.buffer.pos,len);</span><br><span class="line">    r-&gt;io.buffer.pos += len;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Returns read/write position in buffer. */</span></span><br><span class="line"><span class="type">static</span> <span class="type">off_t</span> <span class="title function_">rioBufferTell</span><span class="params">(rio *r)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> r-&gt;io.buffer.pos;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Flushes any buffer to target device if applicable. Returns 1 on success</span></span><br><span class="line"><span class="comment"> * and 0 on failures. */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">rioBufferFlush</span><span class="params">(rio *r)</span> &#123;</span><br><span class="line">    UNUSED(r);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>; <span class="comment">/* Nothing to do, our write just appends to the buffer. */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> rio rioBufferIO = &#123;</span><br><span class="line">    rioBufferRead,</span><br><span class="line">    rioBufferWrite,</span><br><span class="line">    rioBufferTell,</span><br><span class="line">    rioBufferFlush,</span><br><span class="line">    <span class="literal">NULL</span>,           <span class="comment">/* update_checksum */</span></span><br><span class="line">        <span class="number">0</span>,              <span class="comment">/* current checksum */</span></span><br><span class="line">        <span class="number">0</span>,              <span class="comment">/* flags */</span></span><br><span class="line">        <span class="number">0</span>,              <span class="comment">/* bytes read or written */</span></span><br><span class="line">        <span class="number">0</span>,              <span class="comment">/* read/write chunk size */</span></span><br><span class="line">    &#123; &#123; <span class="literal">NULL</span>, <span class="number">0</span> &#125; &#125; <span class="comment">/* union for io-specific vars */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">rioInitWithBuffer</span><span class="params">(rio *r, sds s)</span> &#123;</span><br><span class="line">    *r = rioBufferIO;</span><br><span class="line">    r-&gt;io.buffer.ptr = s;</span><br><span class="line">    r-&gt;io.buffer.pos = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>文件io和缓冲区io相差不大，注意关注文件io的写函数，这里涉及到一个<a target="_blank" rel="noopener" href="https://blog.csdn.net/mengyafei43/article/details/38319783">异步刷盘</a>的问题。</p>
<p>redis对多个操作系统做了兼容,在linux下<code>redis_fsync</code>就是<code>fsync</code>，文件读写也有自己的缓冲区，一旦开启了自动同步<code>io.file.autosync</code>，则每写入一定数量<code>io.file.buffered</code>的数据，就进行同步<code>fsync(fileno(fp))</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Returns 1 or 0 for success/failure. */</span></span><br><span class="line"><span class="type">static</span> <span class="type">size_t</span> <span class="title function_">rioFileWrite</span><span class="params">(rio *r, <span class="type">const</span> <span class="type">void</span> *buf, <span class="type">size_t</span> len)</span> &#123;</span><br><span class="line">    <span class="type">size_t</span> retval;</span><br><span class="line"></span><br><span class="line">    retval = fwrite(buf,len,<span class="number">1</span>,r-&gt;io.file.fp);</span><br><span class="line">    r-&gt;io.file.buffered += len;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;io.file.autosync &amp;&amp;</span><br><span class="line">        r-&gt;io.file.buffered &gt;= r-&gt;io.file.autosync)</span><br><span class="line">    &#123;</span><br><span class="line">        fflush(r-&gt;io.file.fp);</span><br><span class="line">        <span class="keyword">if</span> (redis_fsync(fileno(r-&gt;io.file.fp)) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        r-&gt;io.file.buffered = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来的两个io分别是connection io和 file descriptor io, 前者只实现了从socket中读取数据的接口，后者只实现了向fd中写数据的接口（<code>This target is used to write the RDB file to pipe, when the master just streams the data to the replicas without creating an RDB on-disk image (diskless replication option)</code>）。</p>
<h1 id="rdb-c-rdb-h"><a href="#rdb-c-rdb-h" class="headerlink" title="rdb.c rdb.h"></a>rdb.c rdb.h</h1><h2 id="rdbSaveRio"><a href="#rdbSaveRio" class="headerlink" title="rdbSaveRio"></a>rdbSaveRio</h2><p>直接看函数<code>rdbSaveRio</code>的实现，第一部分是一些准备工作，RDB的版本被储存到了字符串magic中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">rdbSaveRio</span><span class="params">(rio *rdb, <span class="type">int</span> *error, <span class="type">int</span> rdbflags, rdbSaveInfo *rsi)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    dictIterator *di = <span class="literal">NULL</span>;</span><br><span class="line">    dictEntry *de;</span><br><span class="line">    <span class="type">char</span> magic[<span class="number">10</span>];</span><br><span class="line">    <span class="type">uint64_t</span> cksum;</span><br><span class="line">    <span class="type">size_t</span> processed = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> j;</span><br><span class="line">    <span class="type">long</span> key_count = <span class="number">0</span>;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> info_updated_time = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> *pname = (rdbflags &amp; RDBFLAGS_AOF_PREAMBLE) ? <span class="string">&quot;AOF rewrite&quot;</span> :  <span class="string">&quot;RDB&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (server.rdb_checksum)</span><br><span class="line">        rdb-&gt;update_cksum = rioGenericUpdateChecksum;</span><br><span class="line">    <span class="built_in">snprintf</span>(magic,<span class="keyword">sizeof</span>(magic),<span class="string">&quot;REDIS%04d&quot;</span>,RDB_VERSION);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>第二部分<code>rdbWriteRaw</code>直接把magic版本数据写入rdb输出流，<code>rdbSaveInfoAuxFields</code>写入了一些kv对，分别是<code>redis-ver</code>,<code>redis-bits</code>,<code>ctime</code>和<code>used-mem</code>。</p>
<p>对于<code>rdbSaveModulesAux</code>，他是module.c和module.h中的内容，大概就是保存了一个modules字典。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">rdbSaveInfoAuxFields</span><span class="params">(rio *rdb, <span class="type">int</span> rdbflags, rdbSaveInfo *rsi)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (rdbSaveAuxFieldStrStr(rdb,<span class="string">&quot;redis-ver&quot;</span>,REDIS_VERSION) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (rdbSaveAuxFieldStrInt(rdb,<span class="string">&quot;redis-bits&quot;</span>,redis_bits) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (rdbSaveAuxFieldStrInt(rdb,<span class="string">&quot;ctime&quot;</span>,time(<span class="literal">NULL</span>)) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (rdbSaveAuxFieldStrInt(rdb,<span class="string">&quot;used-mem&quot;</span>,zmalloc_used_memory()) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">rdbSaveRio</span><span class="params">(rio *rdb, <span class="type">int</span> *error, <span class="type">int</span> rdbflags, rdbSaveInfo *rsi)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (rdbWriteRaw(rdb,magic,<span class="number">9</span>) == <span class="number">-1</span>) <span class="keyword">goto</span> werr;</span><br><span class="line">    <span class="keyword">if</span> (rdbSaveInfoAuxFields(rdb,rdbflags,rsi) == <span class="number">-1</span>) <span class="keyword">goto</span> werr;</span><br><span class="line">    <span class="keyword">if</span> (rdbSaveModulesAux(rdb, REDISMODULE_AUX_BEFORE_RDB) == <span class="number">-1</span>) <span class="keyword">goto</span> werr;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第三部分开始处理数据库,其主体如下。依次写入了数据库的编号、数据库kv个数，数据库超时kv个数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">rdbSaveRio</span><span class="params">(rio *rdb, <span class="type">int</span> *error, <span class="type">int</span> rdbflags, rdbSaveInfo *rsi)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; server.dbnum; j++) &#123;</span><br><span class="line">        redisDb *db = server.db+j;</span><br><span class="line">        dict *d = db-&gt;dict;</span><br><span class="line">        <span class="keyword">if</span> (dictSize(d) == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">        di = dictGetSafeIterator(d);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Write the SELECT DB opcode */</span></span><br><span class="line">        <span class="keyword">if</span> (rdbSaveType(rdb,RDB_OPCODE_SELECTDB) == <span class="number">-1</span>) <span class="keyword">goto</span> werr;</span><br><span class="line">        <span class="keyword">if</span> (rdbSaveLen(rdb,j) == <span class="number">-1</span>) <span class="keyword">goto</span> werr;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Write the RESIZE DB opcode. */</span></span><br><span class="line">        <span class="type">uint64_t</span> db_size, expires_size;</span><br><span class="line">        db_size = dictSize(db-&gt;dict);</span><br><span class="line">        expires_size = dictSize(db-&gt;expires);</span><br><span class="line">        <span class="keyword">if</span> (rdbSaveType(rdb,RDB_OPCODE_RESIZEDB) == <span class="number">-1</span>) <span class="keyword">goto</span> werr;</span><br><span class="line">        <span class="keyword">if</span> (rdbSaveLen(rdb,db_size) == <span class="number">-1</span>) <span class="keyword">goto</span> werr;</span><br><span class="line">        <span class="keyword">if</span> (rdbSaveLen(rdb,expires_size) == <span class="number">-1</span>) <span class="keyword">goto</span> werr;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Iterate this DB writing every entry */</span></span><br><span class="line">        <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>第三部分的<code>while</code>循环中，对整个数据库的kv字典进行了迭代，依次写入了rio的流。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Iterate this DB writing every entry */</span></span><br><span class="line"><span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    sds keystr = dictGetKey(de);</span><br><span class="line">    robj key, *o = dictGetVal(de);</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> expire;</span><br><span class="line"></span><br><span class="line">    initStaticStringObject(key,keystr);</span><br><span class="line">    expire = getExpire(db,&amp;key);</span><br><span class="line">    <span class="keyword">if</span> (rdbSaveKeyValuePair(rdb,&amp;key,o,expire) == <span class="number">-1</span>) <span class="keyword">goto</span> werr;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* When this RDB is produced as part of an AOF rewrite, move</span></span><br><span class="line"><span class="comment">             * accumulated diff from parent to child while rewriting in</span></span><br><span class="line"><span class="comment">             * order to have a smaller final write. */</span></span><br><span class="line">    <span class="keyword">if</span> (rdbflags &amp; RDBFLAGS_AOF_PREAMBLE &amp;&amp;</span><br><span class="line">        rdb-&gt;processed_bytes &gt; processed+AOF_READ_DIFF_INTERVAL_BYTES)</span><br><span class="line">    &#123;</span><br><span class="line">        processed = rdb-&gt;processed_bytes;</span><br><span class="line">        aofReadDiffFromParent();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Update child info every 1 second (approximately).</span></span><br><span class="line"><span class="comment">             * in order to avoid calling mstime() on each iteration, we will</span></span><br><span class="line"><span class="comment">             * check the diff every 1024 keys */</span></span><br><span class="line">    <span class="keyword">if</span> ((key_count++ &amp; <span class="number">1023</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">long</span> <span class="type">long</span> now = mstime();</span><br><span class="line">        <span class="keyword">if</span> (now - info_updated_time &gt;= <span class="number">1000</span>) &#123;</span><br><span class="line">            sendChildInfo(CHILD_INFO_TYPE_CURRENT_INFO, key_count, pname);</span><br><span class="line">            info_updated_time = now;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后一部分，写入了结束符和checksum</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* If we are storing the replication information on disk, persist</span></span><br><span class="line"><span class="comment">     * the script cache as well: on successful PSYNC after a restart, we need</span></span><br><span class="line"><span class="comment">     * to be able to process any EVALSHA inside the replication backlog the</span></span><br><span class="line"><span class="comment">     * master will send us. */</span></span><br><span class="line"><span class="keyword">if</span> (rsi &amp;&amp; dictSize(server.lua_scripts)) &#123;</span><br><span class="line">    di = dictGetIterator(server.lua_scripts);</span><br><span class="line">    <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        robj *body = dictGetVal(de);</span><br><span class="line">        <span class="keyword">if</span> (rdbSaveAuxField(rdb,<span class="string">&quot;lua&quot;</span>,<span class="number">3</span>,body-&gt;ptr,sdslen(body-&gt;ptr)) == <span class="number">-1</span>)</span><br><span class="line">            <span class="keyword">goto</span> werr;</span><br><span class="line">    &#125;</span><br><span class="line">    dictReleaseIterator(di);</span><br><span class="line">    di = <span class="literal">NULL</span>; <span class="comment">/* So that we don&#x27;t release it again on error. */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (rdbSaveModulesAux(rdb, REDISMODULE_AUX_AFTER_RDB) == <span class="number">-1</span>) <span class="keyword">goto</span> werr;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* EOF opcode */</span></span><br><span class="line"><span class="keyword">if</span> (rdbSaveType(rdb,RDB_OPCODE_EOF) == <span class="number">-1</span>) <span class="keyword">goto</span> werr;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* CRC64 checksum. It will be zero if checksum computation is disabled, the</span></span><br><span class="line"><span class="comment">     * loading code skips the check in this case. */</span></span><br><span class="line">cksum = rdb-&gt;cksum;</span><br><span class="line">memrev64ifbe(&amp;cksum);</span><br><span class="line"><span class="keyword">if</span> (rioWrite(rdb,&amp;cksum,<span class="number">8</span>) == <span class="number">0</span>) <span class="keyword">goto</span> werr;</span><br><span class="line"><span class="keyword">return</span> C_OK;</span><br></pre></td></tr></table></figure>

<h2 id="rdbSave"><a href="#rdbSave" class="headerlink" title="rdbSave"></a>rdbSave</h2><p>首先rdbSave创建了一个名为<code>temp-pid.rdb</code>的文件，该文件将用于输出rdb的结果。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">rdbSave</span><span class="params">(<span class="type">char</span> *filename, rdbSaveInfo *rsi)</span> &#123;</span><br><span class="line">    <span class="type">char</span> tmpfile[<span class="number">256</span>];</span><br><span class="line">    <span class="type">char</span> cwd[MAXPATHLEN]; <span class="comment">/* Current working dir path for error messages. */</span></span><br><span class="line">    FILE *fp = <span class="literal">NULL</span>;</span><br><span class="line">    rio rdb;</span><br><span class="line">    <span class="type">int</span> error = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">snprintf</span>(tmpfile,<span class="number">256</span>,<span class="string">&quot;temp-%d.rdb&quot;</span>, (<span class="type">int</span>) getpid());</span><br><span class="line">    fp = fopen(tmpfile,<span class="string">&quot;w&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!fp) &#123;</span><br><span class="line">        <span class="type">char</span> *cwdp = getcwd(cwd,MAXPATHLEN);</span><br><span class="line">        serverLog(LL_WARNING,</span><br><span class="line">            <span class="string">&quot;Failed opening the RDB file %s (in server root dir %s) &quot;</span></span><br><span class="line">            <span class="string">&quot;for saving: %s&quot;</span>,</span><br><span class="line">            filename,</span><br><span class="line">            cwdp ? cwdp : <span class="string">&quot;unknown&quot;</span>,</span><br><span class="line">            strerror(errno));</span><br><span class="line">        <span class="keyword">return</span> C_ERR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后使用该文件初始化rio流，并根据配置文件rio是否进行自动刷盘。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">rdbSave</span><span class="params">(<span class="type">char</span> *filename, rdbSaveInfo *rsi)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    rioInitWithFile(&amp;rdb,fp);</span><br><span class="line">    startSaving(RDBFLAGS_NONE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (server.rdb_save_incremental_fsync)</span><br><span class="line">        rioSetAutoSync(&amp;rdb,REDIS_AUTOSYNC_BYTES);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>接着执行<code>rdbSaveRio</code>，并刷盘</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">rdbSave</span><span class="params">(<span class="type">char</span> *filename, rdbSaveInfo *rsi)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (rdbSaveRio(&amp;rdb,&amp;error,RDBFLAGS_NONE,rsi) == C_ERR) &#123;</span><br><span class="line">        errno = error;</span><br><span class="line">        <span class="keyword">goto</span> werr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Make sure data will not remain on the OS&#x27;s output buffers */</span></span><br><span class="line">    <span class="keyword">if</span> (fflush(fp)) <span class="keyword">goto</span> werr;</span><br><span class="line">    <span class="keyword">if</span> (fsync(fileno(fp))) <span class="keyword">goto</span> werr;</span><br><span class="line">    <span class="keyword">if</span> (fclose(fp)) &#123; fp = <span class="literal">NULL</span>; <span class="keyword">goto</span> werr; &#125;</span><br><span class="line">    fp = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>最后把这个rdb文件命名为<code>filename</code>，并结束rdb。</p>
<h2 id="rdbSaveBackground"><a href="#rdbSaveBackground" class="headerlink" title="rdbSaveBackground"></a>rdbSaveBackground</h2><p>fork出一个子进程，子进程执行rdb任务。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">rdbSaveBackground</span><span class="params">(<span class="type">char</span> *filename, rdbSaveInfo *rsi)</span> &#123;</span><br><span class="line">    <span class="type">pid_t</span> childpid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hasActiveChildProcess()) <span class="keyword">return</span> C_ERR;</span><br><span class="line"></span><br><span class="line">    server.dirty_before_bgsave = server.dirty;</span><br><span class="line">    server.lastbgsave_try = time(<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((childpid = redisFork(CHILD_TYPE_RDB)) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">int</span> retval;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Child */</span></span><br><span class="line">        redisSetProcTitle(<span class="string">&quot;redis-rdb-bgsave&quot;</span>);</span><br><span class="line">        redisSetCpuAffinity(server.bgsave_cpulist);</span><br><span class="line">        retval = rdbSave(filename,rsi);</span><br><span class="line">        <span class="keyword">if</span> (retval == C_OK) &#123;</span><br><span class="line">            sendChildCowInfo(CHILD_INFO_TYPE_RDB_COW_SIZE, <span class="string">&quot;RDB&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        exitFromChild((retval == C_OK) ? <span class="number">0</span> : <span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* Parent */</span></span><br><span class="line">        <span class="keyword">if</span> (childpid == <span class="number">-1</span>) &#123;</span><br><span class="line">            server.lastbgsave_status = C_ERR;</span><br><span class="line">            serverLog(LL_WARNING,<span class="string">&quot;Can&#x27;t save in background: fork: %s&quot;</span>,</span><br><span class="line">                strerror(errno));</span><br><span class="line">            <span class="keyword">return</span> C_ERR;</span><br><span class="line">        &#125;</span><br><span class="line">        serverLog(LL_NOTICE,<span class="string">&quot;Background saving started by pid %ld&quot;</span>,(<span class="type">long</span>) childpid);</span><br><span class="line">        server.rdb_save_time_start = time(<span class="literal">NULL</span>);</span><br><span class="line">        server.rdb_child_type = RDB_CHILD_TYPE_DISK;</span><br><span class="line">        <span class="keyword">return</span> C_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> C_OK; <span class="comment">/* unreached */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>











<h1 id="Makefile"><a href="#Makefile" class="headerlink" title="Makefile"></a>Makefile</h1><h1 id="acl-c"><a href="#acl-c" class="headerlink" title="acl.c"></a>acl.c</h1><h1 id="ae-c"><a href="#ae-c" class="headerlink" title="ae.c"></a>ae.c</h1><h1 id="ae-h"><a href="#ae-h" class="headerlink" title="ae.h"></a>ae.h</h1><h1 id="ae-epoll-c"><a href="#ae-epoll-c" class="headerlink" title="ae_epoll.c"></a>ae_epoll.c</h1><h1 id="ae-evport-c"><a href="#ae-evport-c" class="headerlink" title="ae_evport.c"></a>ae_evport.c</h1><h1 id="ae-kqueue-c"><a href="#ae-kqueue-c" class="headerlink" title="ae_kqueue.c"></a>ae_kqueue.c</h1><h1 id="ae-select-c"><a href="#ae-select-c" class="headerlink" title="ae_select.c"></a>ae_select.c</h1><h1 id="anet-c"><a href="#anet-c" class="headerlink" title="anet.c"></a>anet.c</h1><h1 id="anet-h"><a href="#anet-h" class="headerlink" title="anet.h"></a>anet.h</h1><h1 id="aof-c"><a href="#aof-c" class="headerlink" title="aof.c"></a>aof.c</h1><h1 id="asciilogo-h"><a href="#asciilogo-h" class="headerlink" title="asciilogo.h"></a>asciilogo.h</h1><h1 id="atomicvar-h"><a href="#atomicvar-h" class="headerlink" title="atomicvar.h"></a>atomicvar.h</h1><h1 id="bio-c"><a href="#bio-c" class="headerlink" title="bio.c"></a>bio.c</h1><h1 id="bio-h"><a href="#bio-h" class="headerlink" title="bio.h"></a>bio.h</h1><h1 id="bitops-c"><a href="#bitops-c" class="headerlink" title="bitops.c"></a>bitops.c</h1><h1 id="blocked-c"><a href="#blocked-c" class="headerlink" title="blocked.c"></a>blocked.c</h1><h1 id="childinfo-c"><a href="#childinfo-c" class="headerlink" title="childinfo.c"></a>childinfo.c</h1><h1 id="cli-common-c"><a href="#cli-common-c" class="headerlink" title="cli_common.c"></a>cli_common.c</h1><h1 id="cli-common-h"><a href="#cli-common-h" class="headerlink" title="cli_common.h"></a>cli_common.h</h1><h1 id="cluster-c"><a href="#cluster-c" class="headerlink" title="cluster.c"></a>cluster.c</h1><h1 id="cluster-h"><a href="#cluster-h" class="headerlink" title="cluster.h"></a>cluster.h</h1><h1 id="config-c"><a href="#config-c" class="headerlink" title="config.c"></a>config.c</h1><h1 id="config-h"><a href="#config-h" class="headerlink" title="config.h"></a>config.h</h1><h1 id="connection-c"><a href="#connection-c" class="headerlink" title="connection.c"></a>connection.c</h1><h1 id="connection-h"><a href="#connection-h" class="headerlink" title="connection.h"></a>connection.h</h1><h1 id="connhelpers-h"><a href="#connhelpers-h" class="headerlink" title="connhelpers.h"></a>connhelpers.h</h1><h1 id="crc16-c"><a href="#crc16-c" class="headerlink" title="crc16.c"></a>crc16.c</h1><h1 id="crc16-slottable-h"><a href="#crc16-slottable-h" class="headerlink" title="crc16_slottable.h"></a>crc16_slottable.h</h1><h1 id="crc64-c"><a href="#crc64-c" class="headerlink" title="crc64.c"></a>crc64.c</h1><h1 id="crc64-h"><a href="#crc64-h" class="headerlink" title="crc64.h"></a>crc64.h</h1><h1 id="crcspeed-c"><a href="#crcspeed-c" class="headerlink" title="crcspeed.c"></a>crcspeed.c</h1><h1 id="crcspeed-h"><a href="#crcspeed-h" class="headerlink" title="crcspeed.h"></a>crcspeed.h</h1><h1 id="db-c"><a href="#db-c" class="headerlink" title="db.c"></a>db.c</h1><h1 id="debug-c"><a href="#debug-c" class="headerlink" title="debug.c"></a>debug.c</h1><h1 id="debugmacro-h"><a href="#debugmacro-h" class="headerlink" title="debugmacro.h"></a>debugmacro.h</h1><h1 id="defrag-c"><a href="#defrag-c" class="headerlink" title="defrag.c"></a>defrag.c</h1><h1 id="endianconv-c"><a href="#endianconv-c" class="headerlink" title="endianconv.c"></a>endianconv.c</h1><h1 id="endianconv-h"><a href="#endianconv-h" class="headerlink" title="endianconv.h"></a>endianconv.h</h1><h1 id="evict-c"><a href="#evict-c" class="headerlink" title="evict.c"></a>evict.c</h1><h1 id="expire-c"><a href="#expire-c" class="headerlink" title="expire.c"></a>expire.c</h1><h1 id="fmacros-h"><a href="#fmacros-h" class="headerlink" title="fmacros.h"></a>fmacros.h</h1><h1 id="geo-c"><a href="#geo-c" class="headerlink" title="geo.c"></a>geo.c</h1><h1 id="geo-h"><a href="#geo-h" class="headerlink" title="geo.h"></a>geo.h</h1><h1 id="geohash-c"><a href="#geohash-c" class="headerlink" title="geohash.c"></a>geohash.c</h1><h1 id="geohash-h"><a href="#geohash-h" class="headerlink" title="geohash.h"></a>geohash.h</h1><h1 id="geohash-helper-c"><a href="#geohash-helper-c" class="headerlink" title="geohash_helper.c"></a>geohash_helper.c</h1><h1 id="geohash-helper-h"><a href="#geohash-helper-h" class="headerlink" title="geohash_helper.h"></a>geohash_helper.h</h1><h1 id="help-h"><a href="#help-h" class="headerlink" title="help.h"></a>help.h</h1><h1 id="hyperloglog-c"><a href="#hyperloglog-c" class="headerlink" title="hyperloglog.c"></a>hyperloglog.c</h1><h1 id="latency-c"><a href="#latency-c" class="headerlink" title="latency.c"></a>latency.c</h1><h1 id="latency-h"><a href="#latency-h" class="headerlink" title="latency.h"></a>latency.h</h1><h1 id="lazyfree-c"><a href="#lazyfree-c" class="headerlink" title="lazyfree.c"></a>lazyfree.c</h1><h1 id="listpack-c"><a href="#listpack-c" class="headerlink" title="listpack.c"></a>listpack.c</h1><h1 id="listpack-h"><a href="#listpack-h" class="headerlink" title="listpack.h"></a>listpack.h</h1><h1 id="listpack-malloc-h"><a href="#listpack-malloc-h" class="headerlink" title="listpack_malloc.h"></a>listpack_malloc.h</h1><h1 id="localtime-c"><a href="#localtime-c" class="headerlink" title="localtime.c"></a>localtime.c</h1><h1 id="lolwut-c"><a href="#lolwut-c" class="headerlink" title="lolwut.c"></a>lolwut.c</h1><h1 id="lolwut-h"><a href="#lolwut-h" class="headerlink" title="lolwut.h"></a>lolwut.h</h1><h1 id="lolwut5-c"><a href="#lolwut5-c" class="headerlink" title="lolwut5.c"></a>lolwut5.c</h1><h1 id="lolwut6-c"><a href="#lolwut6-c" class="headerlink" title="lolwut6.c"></a>lolwut6.c</h1><h1 id="lzf-h"><a href="#lzf-h" class="headerlink" title="lzf.h"></a>lzf.h</h1><h1 id="lzfP-h"><a href="#lzfP-h" class="headerlink" title="lzfP.h"></a>lzfP.h</h1><h1 id="lzf-c-c"><a href="#lzf-c-c" class="headerlink" title="lzf_c.c"></a>lzf_c.c</h1><h1 id="lzf-d-c"><a href="#lzf-d-c" class="headerlink" title="lzf_d.c"></a>lzf_d.c</h1><h1 id="memtest-c"><a href="#memtest-c" class="headerlink" title="memtest.c"></a>memtest.c</h1><h1 id="mkreleasehdr-sh"><a href="#mkreleasehdr-sh" class="headerlink" title="mkreleasehdr.sh"></a>mkreleasehdr.sh</h1><h1 id="module-c"><a href="#module-c" class="headerlink" title="module.c"></a>module.c</h1><h1 id="modules"><a href="#modules" class="headerlink" title="modules"></a>modules</h1><h1 id="monotonic-c"><a href="#monotonic-c" class="headerlink" title="monotonic.c"></a>monotonic.c</h1><h1 id="monotonic-h"><a href="#monotonic-h" class="headerlink" title="monotonic.h"></a>monotonic.h</h1><h1 id="multi-c"><a href="#multi-c" class="headerlink" title="multi.c"></a>multi.c</h1><h1 id="networking-c"><a href="#networking-c" class="headerlink" title="networking.c"></a>networking.c</h1><h1 id="notify-c"><a href="#notify-c" class="headerlink" title="notify.c"></a>notify.c</h1><h1 id="object-c"><a href="#object-c" class="headerlink" title="object.c"></a>object.c</h1><h1 id="pqsort-c"><a href="#pqsort-c" class="headerlink" title="pqsort.c"></a>pqsort.c</h1><h1 id="pqsort-h"><a href="#pqsort-h" class="headerlink" title="pqsort.h"></a>pqsort.h</h1><h1 id="pubsub-c"><a href="#pubsub-c" class="headerlink" title="pubsub.c"></a>pubsub.c</h1><h1 id="quicklist-c"><a href="#quicklist-c" class="headerlink" title="quicklist.c"></a>quicklist.c</h1><h1 id="quicklist-h"><a href="#quicklist-h" class="headerlink" title="quicklist.h"></a>quicklist.h</h1><h1 id="rand-c"><a href="#rand-c" class="headerlink" title="rand.c"></a>rand.c</h1><h1 id="rand-h"><a href="#rand-h" class="headerlink" title="rand.h"></a>rand.h</h1><h1 id="rax-c"><a href="#rax-c" class="headerlink" title="rax.c"></a>rax.c</h1><h1 id="rax-h"><a href="#rax-h" class="headerlink" title="rax.h"></a>rax.h</h1><h1 id="rax-malloc-h"><a href="#rax-malloc-h" class="headerlink" title="rax_malloc.h"></a>rax_malloc.h</h1><h1 id="redis-benchmark-c"><a href="#redis-benchmark-c" class="headerlink" title="redis-benchmark.c"></a>redis-benchmark.c</h1><h1 id="redis-check-aof-c"><a href="#redis-check-aof-c" class="headerlink" title="redis-check-aof.c"></a>redis-check-aof.c</h1><h1 id="redis-check-rdb-c"><a href="#redis-check-rdb-c" class="headerlink" title="redis-check-rdb.c"></a>redis-check-rdb.c</h1><h1 id="redis-cli-c"><a href="#redis-cli-c" class="headerlink" title="redis-cli.c"></a>redis-cli.c</h1><h1 id="redis-trib-rb"><a href="#redis-trib-rb" class="headerlink" title="redis-trib.rb"></a>redis-trib.rb</h1><h1 id="redisassert-c"><a href="#redisassert-c" class="headerlink" title="redisassert.c"></a>redisassert.c</h1><h1 id="redisassert-h"><a href="#redisassert-h" class="headerlink" title="redisassert.h"></a>redisassert.h</h1><h1 id="redismodule-h"><a href="#redismodule-h" class="headerlink" title="redismodule.h"></a>redismodule.h</h1><h1 id="release-c"><a href="#release-c" class="headerlink" title="release.c"></a>release.c</h1><h1 id="replication-c"><a href="#replication-c" class="headerlink" title="replication.c"></a>replication.c</h1><h1 id="scripting-c"><a href="#scripting-c" class="headerlink" title="scripting.c"></a>scripting.c</h1><h1 id="sdsalloc-h"><a href="#sdsalloc-h" class="headerlink" title="sdsalloc.h"></a>sdsalloc.h</h1><h1 id="sentinel-c"><a href="#sentinel-c" class="headerlink" title="sentinel.c"></a>sentinel.c</h1><h1 id="server-c"><a href="#server-c" class="headerlink" title="server.c"></a>server.c</h1><h1 id="server-h"><a href="#server-h" class="headerlink" title="server.h"></a>server.h</h1><h1 id="setcpuaffinity-c"><a href="#setcpuaffinity-c" class="headerlink" title="setcpuaffinity.c"></a>setcpuaffinity.c</h1><h1 id="setproctitle-c"><a href="#setproctitle-c" class="headerlink" title="setproctitle.c"></a>setproctitle.c</h1><h1 id="sha1-c"><a href="#sha1-c" class="headerlink" title="sha1.c"></a>sha1.c</h1><h1 id="sha1-h"><a href="#sha1-h" class="headerlink" title="sha1.h"></a>sha1.h</h1><h1 id="sha256-c"><a href="#sha256-c" class="headerlink" title="sha256.c"></a>sha256.c</h1><h1 id="sha256-h"><a href="#sha256-h" class="headerlink" title="sha256.h"></a>sha256.h</h1><h1 id="siphash-c"><a href="#siphash-c" class="headerlink" title="siphash.c"></a>siphash.c</h1><h1 id="slowlog-c"><a href="#slowlog-c" class="headerlink" title="slowlog.c"></a>slowlog.c</h1><h1 id="slowlog-h"><a href="#slowlog-h" class="headerlink" title="slowlog.h"></a>slowlog.h</h1><h1 id="solarisfixes-h"><a href="#solarisfixes-h" class="headerlink" title="solarisfixes.h"></a>solarisfixes.h</h1><h1 id="sort-c"><a href="#sort-c" class="headerlink" title="sort.c"></a>sort.c</h1><h1 id="sparkline-c"><a href="#sparkline-c" class="headerlink" title="sparkline.c"></a>sparkline.c</h1><h1 id="sparkline-h"><a href="#sparkline-h" class="headerlink" title="sparkline.h"></a>sparkline.h</h1><h1 id="stream-h"><a href="#stream-h" class="headerlink" title="stream.h"></a>stream.h</h1><h1 id="syncio-c"><a href="#syncio-c" class="headerlink" title="syncio.c"></a>syncio.c</h1><h1 id="t-hash-c"><a href="#t-hash-c" class="headerlink" title="t_hash.c"></a>t_hash.c</h1><h1 id="t-list-c"><a href="#t-list-c" class="headerlink" title="t_list.c"></a>t_list.c</h1><h1 id="t-set-c"><a href="#t-set-c" class="headerlink" title="t_set.c"></a>t_set.c</h1><h1 id="t-stream-c"><a href="#t-stream-c" class="headerlink" title="t_stream.c"></a>t_stream.c</h1><h1 id="t-string-c"><a href="#t-string-c" class="headerlink" title="t_string.c"></a>t_string.c</h1><h1 id="t-zset-c"><a href="#t-zset-c" class="headerlink" title="t_zset.c"></a>t_zset.c</h1><h1 id="testhelp-h"><a href="#testhelp-h" class="headerlink" title="testhelp.h"></a>testhelp.h</h1><h1 id="timeout-c"><a href="#timeout-c" class="headerlink" title="timeout.c"></a>timeout.c</h1><h1 id="tls-c"><a href="#tls-c" class="headerlink" title="tls.c"></a>tls.c</h1><h1 id="tracking-c"><a href="#tracking-c" class="headerlink" title="tracking.c"></a>tracking.c</h1><h1 id="util-c"><a href="#util-c" class="headerlink" title="util.c"></a>util.c</h1><h1 id="util-h"><a href="#util-h" class="headerlink" title="util.h"></a>util.h</h1><h1 id="valgrind-sup"><a href="#valgrind-sup" class="headerlink" title="valgrind.sup"></a>valgrind.sup</h1><h1 id="version-h"><a href="#version-h" class="headerlink" title="version.h"></a>version.h</h1><h1 id="zipmap-c"><a href="#zipmap-c" class="headerlink" title="zipmap.c"></a>zipmap.c</h1><h1 id="zipmap-h"><a href="#zipmap-h" class="headerlink" title="zipmap.h"></a>zipmap.h</h1><h1 id="zmalloc-c"><a href="#zmalloc-c" class="headerlink" title="zmalloc.c"></a>zmalloc.c</h1><h1 id="zmalloc-h"><a href="#zmalloc-h" class="headerlink" title="zmalloc.h"></a>zmalloc.h</h1>
        
    

    
</div>


                

                <!-- Post Comments -->
                
                    
    <!-- 使用 DISQUS -->
<div id="disqus-comment">
    <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'http://fightinggg.github.io/material/QVAQR0.html';  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = 'http://fightinggg.github.io/material/QVAQR0.html'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
</script>
<script type="text/ls-javascript" id="disqus-thread-script">
    queue.offer(function() {
            (function() { // DON'T EDIT BELOW THIS LINE
                var d = document;
                var s = d.createElement('script');
                s.src = '//.disqus.com/embed.js';
                s.setAttribute('data-timestamp', + new Date());
                (d.head || d.body).appendChild(s);
            })();
        });
</script>

</div>
<style>
    #disqus-comment{
        background-color: #eee;
        padding: 2pc;
    }
</style>

                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    
        <a href="/material/QVZE5O.html" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            新篇
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/material/QV7MPT.html" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/material/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/material/img/avatar.png" alt="fightinggg's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        youremail@email.com
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="#" target="_blank" title="Email Me">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/material/">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                主页
            </a>
        </li>
        
    

    <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    归档
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="/material/archives/2023/05/">五月 2023<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/material/archives/2023/03/">三月 2023<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/material/archives/2023/02/">二月 2023<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/material/archives/2022/07/">七月 2022<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/material/archives/2022/05/">五月 2022<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/material/archives/2022/03/">三月 2022<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/material/archives/2022/02/">二月 2022<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/material/archives/2022/01/">一月 2022<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/material/archives/2021/11/">十一月 2021<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/material/archives/2021/10/">十月 2021<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/material/archives/2021/09/">九月 2021<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/material/archives/2021/08/">八月 2021<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/material/archives/2021/07/">七月 2021<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/material/archives/2021/06/">六月 2021<span class="sidebar_archives-count">7</span></a></li><li><a class="sidebar_archives-link" href="/material/archives/2021/05/">五月 2021<span class="sidebar_archives-count">14</span></a></li><li><a class="sidebar_archives-link" href="/material/archives/2021/04/">四月 2021<span class="sidebar_archives-count">20</span></a></li><li><a class="sidebar_archives-link" href="/material/archives/2021/03/">三月 2021<span class="sidebar_archives-count">16</span></a></li><li><a class="sidebar_archives-link" href="/material/archives/2021/01/">一月 2021<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/material/archives/2020/12/">十二月 2020<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/material/archives/2020/11/">十一月 2020<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/material/archives/2020/10/">十月 2020<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/material/archives/2020/09/">九月 2020<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/material/archives/2020/08/">八月 2020<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/material/archives/2020/06/">六月 2020<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/material/archives/2020/05/">五月 2020<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/material/archives/2020/04/">四月 2020<span class="sidebar_archives-count">80</span></a></li><li><a class="sidebar_archives-link" href="/material/archives/2020/03/">三月 2020<span class="sidebar_archives-count">43</span></a></li><li><a class="sidebar_archives-link" href="/material/archives/2020/02/">二月 2020<span class="sidebar_archives-count">12</span></a></li><li><a class="sidebar_archives-link" href="/material/archives/2019/12/">十二月 2019<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/material/archives/2019/11/">十一月 2019<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/material/archives/2019/10/">十月 2019<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/material/archives/2019/09/">九月 2019<span class="sidebar_archives-count">8</span></a></li><li><a class="sidebar_archives-link" href="/material/archives/2019/08/">八月 2019<span class="sidebar_archives-count">140</span></a></li><li><a class="sidebar_archives-link" href="/material/archives/2019/07/">七月 2019<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/material/archives/2019/06/">六月 2019<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/material/archives/2019/05/">五月 2019<span class="sidebar_archives-count">11</span></a></li><li><a class="sidebar_archives-link" href="/material/archives/2019/04/">四月 2019<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/material/archives/2019/03/">三月 2019<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/material/archives/2019/02/">二月 2019<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/material/archives/2019/01/">一月 2019<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/material/archives/2018/12/">十二月 2018<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/material/archives/2018/11/">十一月 2018<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/material/archives/2018/10/">十月 2018<span class="sidebar_archives-count">21</span></a></li><li><a class="sidebar_archives-link" href="/material/archives/2018/03/">三月 2018<span class="sidebar_archives-count">1</span></a>
            </ul>
        </li>
        
    

    <!-- Categories  -->
    

    <!-- Pages  -->
    

    <!-- Article Number  -->
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->

    <div class="sidebar-divider"></div>


<!-- Theme Material -->

    <a href="https://github.com/bollnh/hexo-theme-material"  class="sidebar-footer-text-a" target="_blank">
        <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
            主题 - Material
            <span class="sidebar-badge badge-circle">i</span>
        </div>
    </a>


<!-- Help & Support -->
<!--

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div id="back-to-top" class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    
        <a href="https://twitter.com/twitter" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-twitter">
                <span class="visuallyhidden">Twitter</span>
            </button><!--
     --></a>
    

    <!-- Facebook -->
    
        <a href="https://www.facebook.com/facebook" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-facebook">
                <span class="visuallyhidden">Facebook</span>
            </button><!--
     --></a>
    

    <!-- Google + -->
    
        <a href="https://www.google.com/" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-gplus">
                <span class="visuallyhidden">Google Plus</span>
            </button><!--
     --></a>
    

    <!-- Weibo -->
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    

    <!-- V2EX -->
    

    <!-- Segmentfault -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©&nbsp;<span year></span>&nbsp;Believe it
            
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/bollnh/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import JS File -->

    <script>lsloader.load("lazyload_js","/material/js/lazyload.min.js?1BcfzuNXqV+ntF6gq+5X3Q==", true)</script>



    <script>lsloader.load("js_js","/material/js/js.min.js?Bn9UzEm8RrBSxqyZB0zPjA==", true)</script>



    <script>lsloader.load("np_js","/material/js/nprogress.js?pl3Qhb9lvqR1FlyLUna1Yw==", true)</script>


<script type="text/ls-javascript" id="NProgress-script">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>









   <!-- 使用 DISQUS js 代码 -->
<script id="dsq-count-scr" src="//.disqus.com/count.js" async></script>





<!-- UC Browser Compatible -->
<!-- <script>
	var agent = navigator.userAgent.toLowerCase();
	if(agent.indexOf('ucbrowser')>0) {
		document.write('
<link rel="stylesheet" href="/material/css/uc.css">
');
	   alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
	}
</script> -->

<!-- Import prettify js  -->



<!-- Window Load -->
<!-- add class for prettify -->
<script type="text/ls-javascript" id="window-load">
    $(window).on('load', function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });

    
    
</script>

<!-- MathJax Load-->


<!-- Bing Background -->


<script type="text/ls-javascript" id="lazy-load">
    // Offer LazyLoad
    queue.offer(function(){
        $('.lazy').lazyload({
            effect : 'show'
        });
    });

    // Start Queue
    $(document).ready(function(){
        setInterval(function(){
            queue.execNext();
        },200);
    });
</script>

<!-- Custom Footer -->



<script>
    var copyrightNow = new Date().getFullYear();
    var textContent = document.querySelector('span[year]')

    copyrightSince = 0000;
    if (copyrightSince === copyrightNow||copyrightSince === 0000) {
        textContent.textContent = copyrightNow
    } else {
        textContent.textContent = copyrightSince + ' - ' + copyrightNow
    }

    (function(){
        var scriptList = document.querySelectorAll('script[type="text/ls-javascript"]')

        for (var i = 0; i < scriptList.length; ++i) {
            var item = scriptList[i];
            lsloader.runInlineScript(item.id,item.id);
        }
    })()
console.log('\n %c © Material Theme | Version: 1.5.6 | https://github.com/bollnh/hexo-theme-material %c \n', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-left-radius:5px;border-bottom-left-radius:5px;', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-right-radius:5px;border-bottom-right-radius:5px;');
</script>

                </main>
            </div>
        </body>
    
</html>
