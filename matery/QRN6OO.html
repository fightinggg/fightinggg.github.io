<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="自己动手写Docker, Believe it">
    <meta name="description" content="O ever youthful, O ever weeping">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>自己动手写Docker | Believe it</title>
    <link rel="icon" type="image/png" href="/matery/favicon.png">

    <link rel="stylesheet" type="text/css" href="/matery/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/matery/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/matery/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/matery/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/matery/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/matery/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/matery/css/my.css">

    <script src="/matery/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 6.3.0"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/matery/" class="waves-effect waves-light">
                    
                    <img src="/matery/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Believe it</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/matery/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/matery/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/matery/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/matery/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/matery/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/matery/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/matery/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/matery/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Believe it</div>
        <div class="logo-desc">
            
            O ever youthful, O ever weeping
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/matery/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/matery/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/matery/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/matery/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/matery/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/matery/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/matery/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/matery/medias/featureimages/1.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">自己动手写Docker</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/matery/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/matery/tags/%E8%AF%BB%E4%B9%A6/">
                                <span class="chip bg-color">读书</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/matery/categories/Docker/" class="post-category">
                                Docker
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-04-16
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <div><a href="/next/QRN6OO.html" style="border-bottom: 0px;border-bottom: 0px;
            background: #4FC921;
            color: white;
            border-radius: 5px;
            padding: 2px 6px 2px 6px;
            margin: 2px 6px 2px 6px;
            text-decoration: none;
            float: left;
            ">next</a><a href="/hexonext/QRN6OO.html" style="border-bottom: 0px;border-bottom: 0px;
            background: #4FC921;
            color: white;
            border-radius: 5px;
            padding: 2px 6px 2px 6px;
            margin: 2px 6px 2px 6px;
            text-decoration: none;
            float: left;
            ">hexonext</a><a href="/butterfly/QRN6OO.html" style="border-bottom: 0px;border-bottom: 0px;
            background: #4FC921;
            color: white;
            border-radius: 5px;
            padding: 2px 6px 2px 6px;
            margin: 2px 6px 2px 6px;
            text-decoration: none;
            float: left;
            ">butterfly</a><a href="/volantis/QRN6OO.html" style="border-bottom: 0px;border-bottom: 0px;
            background: #4FC921;
            color: white;
            border-radius: 5px;
            padding: 2px 6px 2px 6px;
            margin: 2px 6px 2px 6px;
            text-decoration: none;
            float: left;
            ">volantis</a><a href="/yearn/QRN6OO.html" style="border-bottom: 0px;border-bottom: 0px;
            background: #4FC921;
            color: white;
            border-radius: 5px;
            padding: 2px 6px 2px 6px;
            margin: 2px 6px 2px 6px;
            text-decoration: none;
            float: left;
            ">yearn</a><a href="/yilia/QRN6OO.html" style="border-bottom: 0px;border-bottom: 0px;
            background: #4FC921;
            color: white;
            border-radius: 5px;
            padding: 2px 6px 2px 6px;
            margin: 2px 6px 2px 6px;
            text-decoration: none;
            float: left;
            ">yilia</a><a href="/shoka/QRN6OO.html" style="border-bottom: 0px;border-bottom: 0px;
            background: #4FC921;
            color: white;
            border-radius: 5px;
            padding: 2px 6px 2px 6px;
            margin: 2px 6px 2px 6px;
            text-decoration: none;
            float: left;
            ">shoka</a><a href="/indigo/QRN6OO.html" style="border-bottom: 0px;border-bottom: 0px;
            background: #4FC921;
            color: white;
            border-radius: 5px;
            padding: 2px 6px 2px 6px;
            margin: 2px 6px 2px 6px;
            text-decoration: none;
            float: left;
            ">indigo</a><a href="/apollo/QRN6OO.html" style="border-bottom: 0px;border-bottom: 0px;
            background: #4FC921;
            color: white;
            border-radius: 5px;
            padding: 2px 6px 2px 6px;
            margin: 2px 6px 2px 6px;
            text-decoration: none;
            float: left;
            ">apollo</a><a href="/landscape/QRN6OO.html" style="border-bottom: 0px;border-bottom: 0px;
            background: #4FC921;
            color: white;
            border-radius: 5px;
            padding: 2px 6px 2px 6px;
            margin: 2px 6px 2px 6px;
            text-decoration: none;
            float: left;
            ">landscape</a><a href="/cactus/QRN6OO.html" style="border-bottom: 0px;border-bottom: 0px;
            background: #4FC921;
            color: white;
            border-radius: 5px;
            padding: 2px 6px 2px 6px;
            margin: 2px 6px 2px 6px;
            text-decoration: none;
            float: left;
            ">cactus</a><a href="/matery/QRN6OO.html" style="border-bottom: 0px;border-bottom: 0px;
            background: #4FC921;
            color: white;
            border-radius: 5px;
            padding: 2px 6px 2px 6px;
            margin: 2px 6px 2px 6px;
            text-decoration: none;
            float: left;
            ">matery</a><a href="/icarus/QRN6OO.html" style="border-bottom: 0px;border-bottom: 0px;
            background: #4FC921;
            color: white;
            border-radius: 5px;
            padding: 2px 6px 2px 6px;
            margin: 2px 6px 2px 6px;
            text-decoration: none;
            float: left;
            ">icarus</a><a href="/fluid/QRN6OO.html" style="border-bottom: 0px;border-bottom: 0px;
            background: #4FC921;
            color: white;
            border-radius: 5px;
            padding: 2px 6px 2px 6px;
            margin: 2px 6px 2px 6px;
            text-decoration: none;
            float: left;
            ">fluid</a><a href="/material/QRN6OO.html" style="border-bottom: 0px;border-bottom: 0px;
            background: #4FC921;
            color: white;
            border-radius: 5px;
            padding: 2px 6px 2px 6px;
            margin: 2px 6px 2px 6px;
            text-decoration: none;
            float: left;
            ">material</a><div style="clear: both;"></div></div>



<p><img src='/image-2021-04-16-13.59.48.106.png'></img></p>
<h1 id="容器与开发语言"><a href="#容器与开发语言" class="headerlink" title="容器与开发语言"></a>容器与开发语言</h1><h2 id="容器"><a href="#容器" class="headerlink" title="容器"></a>容器</h2><p>随着云计算领域的兴起，容器这个词出现了，但是什么是容器？</p>
<p>容器英文名Container，是基于Linux Namespace以及Cgroups技术实现的具备隔离特性的一组进程。</p>
<p>OK，他是一组具备隔离特性的进程。</p>
<h2 id="虚拟机"><a href="#虚拟机" class="headerlink" title="虚拟机"></a>虚拟机</h2><p>虚拟机是使用Hypervisor技术提供的虚拟化硬件的操作系统。</p>
<p>OK，虚拟机是一个操作系统。</p>
<span id="more"></span>

<h2 id="操作系统和进程的区别"><a href="#操作系统和进程的区别" class="headerlink" title="操作系统和进程的区别"></a>操作系统和进程的区别</h2><p>操作系统是管理软件、硬件的一组进程。</p>
<h2 id="GO"><a href="#GO" class="headerlink" title="GO"></a>GO</h2><p>这里不做介绍（其实我只能看懂一点点Go代码，没时间学，后面有机会再出这方面的Blog吧）</p>
<h1 id="基础技术"><a href="#基础技术" class="headerlink" title="基础技术"></a>基础技术</h1><h2 id="Linux-Namespace"><a href="#Linux-Namespace" class="headerlink" title="Linux Namespace"></a>Linux Namespace</h2><p>Namespace即为名称空间，这是一个树状的结构，父名称空间可以看到子名称空间的所有内容，反之则不行。这类似于Spring框架的父子Beanfactory。</p>
<p>Linux 一个实现了6个不同的Namespace</p>
<table>
<thead>
<tr>
<th align="center">Namespace 类型</th>
<th align="center">系统调用参数</th>
<th align="center">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Mount Namespace</td>
<td align="center">CLONE NEWNS</td>
<td align="center">文件系统挂载点</td>
</tr>
<tr>
<td align="center">UTS Namespace</td>
<td align="center">CLONE NEWUTS</td>
<td align="center">主机名</td>
</tr>
<tr>
<td align="center">IPC Namespace</td>
<td align="center">CLONE NEWIPC</td>
<td align="center">进程通信</td>
</tr>
<tr>
<td align="center">PID Namespace</td>
<td align="center">CLONE NEWPID</td>
<td align="center">进程ID</td>
</tr>
<tr>
<td align="center">Network Namespace</td>
<td align="center">CLONE NEWNET</td>
<td align="center">网络</td>
</tr>
<tr>
<td align="center">User Namespace</td>
<td align="center">CLONE NEWUSER</td>
<td align="center">用户</td>
</tr>
</tbody></table>
<p>对于这些Namespace，Linux提供了3个系统调用。</p>
<table>
<thead>
<tr>
<th align="center">API</th>
<th align="center">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="center">clone</td>
<td align="center">创建新进程，并为其分配6个名称空间</td>
</tr>
<tr>
<td align="center">unshare</td>
<td align="center">把进程移出名称空间</td>
</tr>
<tr>
<td align="center">setns</td>
<td align="center">把进程加入名称空间</td>
</tr>
</tbody></table>
<h3 id="UTS-Namespace"><a href="#UTS-Namespace" class="headerlink" title="UTS Namespace"></a>UTS Namespace</h3><p>下面是一个<code>main.go</code>文件，我们使用指令<code>go run main.go</code></p>
<blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;os/exec&quot;</span></span><br><span class="line">  <span class="string">&quot;syscall&quot;</span></span><br><span class="line">  <span class="string">&quot;os&quot;</span></span><br><span class="line">  <span class="string">&quot;log&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span> <span class="params">()</span></span> &#123;</span><br><span class="line">  cmd := exec.Command(<span class="string">&quot;sh&quot;</span>)</span><br><span class="line">  cmd.SysProcAttr = &amp;syscall.SysProcAttr&#123;</span><br><span class="line">    Cloneflags: syscall.CLONE_NEWUTS,</span><br><span class="line">  &#125;</span><br><span class="line">  cmd.Stdin = os.Stdin</span><br><span class="line">  cmd.Stdout = os.Stdout</span><br><span class="line">  cmd.Stderr = os.Stderr</span><br><span class="line">  <span class="keyword">if</span> err := cmd.Run(); err!= <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatal(err)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>取自原书第10页</p>
</blockquote>
<p>然后我们发现我们进入到了一个shell命令中。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-4-4-centos tmp]<span class="comment"># go run main.go </span></span><br><span class="line">sh-4.4<span class="comment"># </span></span><br></pre></td></tr></table></figure>

<p>接下来我们查看hostname并更改然后再次查看。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-4-4-centos tmp]<span class="comment"># go run main.go </span></span><br><span class="line">sh-4.4<span class="comment"># hostname</span></span><br><span class="line">VM-4-4-centos</span><br><span class="line">sh-4.4<span class="comment"># hostname</span></span><br><span class="line">VM-4-4-centos</span><br><span class="line">sh-4.4<span class="comment"># hostname wsx</span></span><br><span class="line">sh-4.4<span class="comment"># hostname</span></span><br><span class="line">wsx</span><br><span class="line">sh-4.4<span class="comment"># </span></span><br></pre></td></tr></table></figure>

<p>回到宿主机上使用指令hostname,发现宿主机的hostname并没有发生改变。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-4-4-centos src]<span class="comment"># hostname</span></span><br><span class="line">VM-4-4-centos</span><br><span class="line">[root@VM-4-4-centos src]<span class="comment"># </span></span><br></pre></td></tr></table></figure>

<p>我们使用指令<code>ps -ef | grep $$</code>查看当前进程的pid为1539189， ppid为1539185。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sh-4.4<span class="comment"># ps -ef | grep $$</span></span><br><span class="line">root     1539189 1539185  0 15:01 pts/0    00:00:00 sh</span><br><span class="line">root     1540099 1539189  0 15:05 pts/0    00:00:00 ps -ef</span><br><span class="line">root     1540100 1539189  0 15:05 pts/0    00:00:00 grep 1539189</span><br></pre></td></tr></table></figure>

<p>然后分别查看他们的ns空间, 不难发现只有uts空间不一样。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sh-4.4<span class="comment"># ls -l /proc/$$/ns</span></span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 16 15:08 cgroup -&gt; <span class="string">&#x27;cgroup:[4026531835]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 16 15:08 ipc -&gt; <span class="string">&#x27;ipc:[4026531839]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 16 15:08 mnt -&gt; <span class="string">&#x27;mnt:[4026531840]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 16 15:08 net -&gt; <span class="string">&#x27;net:[4026531992]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 16 15:08 pid -&gt; <span class="string">&#x27;pid:[4026531836]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 16 15:08 pid_for_children -&gt; <span class="string">&#x27;pid:[4026531836]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 16 15:08 user -&gt; <span class="string">&#x27;user:[4026531837]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 16 15:06 uts -&gt; <span class="string">&#x27;uts:[4026532643]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 16 15:07 uts -&gt; <span class="string">&#x27;uts:[4026531838]&#x27;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sh-4.4<span class="comment"># ls -l /proc/1539185/ns</span></span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 16 15:08 cgroup -&gt; <span class="string">&#x27;cgroup:[4026531835]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 16 15:08 ipc -&gt; <span class="string">&#x27;ipc:[4026531839]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 16 15:08 mnt -&gt; <span class="string">&#x27;mnt:[4026531840]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 16 15:08 net -&gt; <span class="string">&#x27;net:[4026531992]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 16 15:08 pid -&gt; <span class="string">&#x27;pid:[4026531836]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 16 15:08 pid_for_children -&gt; <span class="string">&#x27;pid:[4026531836]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 16 15:08 user -&gt; <span class="string">&#x27;user:[4026531837]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 16 15:07 uts -&gt; <span class="string">&#x27;uts:[4026531838]&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="其他的Namespace"><a href="#其他的Namespace" class="headerlink" title="其他的Namespace"></a>其他的Namespace</h3><p>更多的例子可以查看原书11-19页，即可实现其他5个空间的隔离，其实只需要修改代码为下面这样即可。我们只需要使用符号 <code>|</code>就能同时开启多个资源的隔离。 </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cmd.SysProcAttr = &amp;syscall.SysProcAttr&#123;</span><br><span class="line">  Cloneflags: syscall.CLONE_NEWUTS | syscall.CLONE_NEWIPC,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Linux-Cgroups"><a href="#Linux-Cgroups" class="headerlink" title="Linux Cgroups"></a>Linux Cgroups</h2><p>有了资源隔离，还差一点东西才能实现容器，那就是资源限制、控制、统计（包括CPU、Memory、IO等）。Linux Cgroups就是干这个事的。</p>
<blockquote>
<p>cgroups（Control Groups）最初叫 Process Container，由 Google 工程师（Paul Menage 和 Rohit Seth）于 2006 年提出，后来因为 Container 有多重含义容易引起误解，就在 2007 年更名为 Control Groups，并被整合进 Linux 内核。顾名思义就是把进程放到一个组里面统一加以控制。</p>
<p>引用自： <a target="_blank" rel="noopener" href="https://www.infoq.cn/article/docker-kernel-knowledge-cgroups-resource-isolation">原文链接</a></p>
</blockquote>
<h3 id="Task"><a href="#Task" class="headerlink" title="Task"></a>Task</h3><p>在Cgroups术语中，Task就是一个进程。</p>
<h3 id="Cgroup"><a href="#Cgroup" class="headerlink" title="Cgroup"></a>Cgroup</h3><p>即一个控制组，可以对一组进程进行配置。</p>
<h3 id="Subsystem"><a href="#Subsystem" class="headerlink" title="Subsystem"></a>Subsystem</h3><p>具体的配置子系统，例如cpu子系统可以配置Cgroup中进程被调度的策略，memory子系统可以控制Cgroup中进程的内存占用。</p>
<h3 id="Hierarchy"><a href="#Hierarchy" class="headerlink" title="Hierarchy"></a>Hierarchy</h3><p>hierarchy把cgroup描述为一个树状结构，在这个树状结构中，Cgroups完成了继承，就和前面的Linux Namespace一样。</p>
<h3 id="安装Cgroup库"><a href="#安装Cgroup库" class="headerlink" title="安装Cgroup库"></a>安装Cgroup库</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y libcgroup-tools.x86_64</span><br></pre></td></tr></table></figure>

<h3 id="查看cgroup"><a href="#查看cgroup" class="headerlink" title="查看cgroup"></a>查看cgroup</h3><p>我们可以看到这里有很多cgroup，冒号左边是子系统，右边是cgroup。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-4-4-centos cpu]<span class="comment"># lscgroup | head -n 15</span></span><br><span class="line">cpu,cpuacct:/</span><br><span class="line">cpu,cpuacct:/YunJing</span><br><span class="line">cpu,cpuacct:/docker</span><br><span class="line">cpu,cpuacct:/docker/de0ca6c8064d53b51a3076317c90c472b3b62e31d5110c08a9e158d4470bde2a</span><br><span class="line">cpu,cpuacct:/docker/5e0cd00a0390669e38f844b1ecf56c63dc8d406d0c12d330d278ff137aafd2d2</span><br><span class="line">cpu,cpuacct:/docker/29f1d2a9d2d3baaf7e108696dace633e84a75dca7182b3015d0a632d72b2f1f8</span><br><span class="line">cpu,cpuacct:/docker/d97f48af25382fad8175a285dfe3c6ebc93fe28d022c534c20c35152a47e9a09</span><br><span class="line">cpu,cpuacct:/docker/dfdc0ad0ca19f736e8bb70abcbdbbd75b483b9830920097566e01bb8dc83d1b6</span><br><span class="line">cpu,cpuacct:/docker/28c73206d27e9bfcbca5fd9f801ff96a57cd07c5b6806f1bcf5932e4643296e1</span><br><span class="line">cpu,cpuacct:/docker/9852a95cfef5ff071cb4554ea73b6699be0ab5aa08f873abe1575ef07c31c68f</span><br><span class="line">cpu,cpuacct:/docker/a3845de540c9eaa8dc609b67d09fb40f262a0bc286eef8363607d4fba68dad36</span><br><span class="line">cpu,cpuacct:/docker/d46d67f40ea34e5a9e0aaf9e32d0438d9fc9c0db614c2e60139971ab7917602f</span><br><span class="line">cpu,cpuacct:/docker/a3fa62cd8e9ec321a708e81c0f5aa1048b636815db225e1f9b3252dd9f676913</span><br><span class="line">cpu,cpuacct:/user.slice</span><br><span class="line">cpu,cpuacct:/init.scope</span><br></pre></td></tr></table></figure>

<h3 id="查看子系统"><a href="#查看子系统" class="headerlink" title="查看子系统"></a>查看子系统</h3><p>下面的指令会列出所有的子系统，一般就几个子系统。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-4-4-centos cpu]<span class="comment"># lssubsys -a</span></span><br><span class="line">cpuset</span><br><span class="line">cpu,cpuacct</span><br><span class="line">blkio</span><br><span class="line">memory</span><br><span class="line">devices</span><br><span class="line">freezer</span><br><span class="line">net_cls,net_prio</span><br><span class="line">perf_event</span><br><span class="line">hugetlb</span><br><span class="line">pids</span><br><span class="line">rdma</span><br></pre></td></tr></table></figure>

<h3 id="查看子系统挂载"><a href="#查看子系统挂载" class="headerlink" title="查看子系统挂载"></a>查看子系统挂载</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-4-4-centos src]<span class="comment"># lssubsys -m</span></span><br><span class="line">cpuset /sys/fs/cgroup/cpuset</span><br><span class="line">cpu,cpuacct /sys/fs/cgroup/cpu,cpuacct</span><br><span class="line">blkio /sys/fs/cgroup/blkio</span><br><span class="line">memory /sys/fs/cgroup/memory</span><br><span class="line">devices /sys/fs/cgroup/devices</span><br><span class="line">freezer /sys/fs/cgroup/freezer</span><br><span class="line">net_cls,net_prio /sys/fs/cgroup/net_cls,net_prio</span><br><span class="line">perf_event /sys/fs/cgroup/perf_event</span><br><span class="line">hugetlb /sys/fs/cgroup/hugetlb</span><br><span class="line">pids /sys/fs/cgroup/pids</span><br><span class="line">rdma /sys/fs/cgroup/rdma</span><br></pre></td></tr></table></figure>



<h3 id="Cgroup例子"><a href="#Cgroup例子" class="headerlink" title="Cgroup例子"></a>Cgroup例子</h3><p>如下图所示，cgroup（粉色） 是一个树状结构，组成了一个Hierarchy（绿色），而每一个子系统（蓝色）可以分配到一个Hierarchy上。</p>
<p><img src='/image-2021-04-17-13.55.00.000.svg'></img></p>
<h3 id="Cgroups三个组件的约束"><a href="#Cgroups三个组件的约束" class="headerlink" title="Cgroups三个组件的约束"></a>Cgroups三个组件的约束</h3><blockquote>
<p>系统在创建了新的 hierarchy之后,系统中所有的进程都会加入这个 hierarchy的 cgroup根节点,这个 cgroup根节点是 hierarchy默认创建的。</p>
<p>一个 subsystem只能附加到一个 hierarchy上面。</p>
<p>一个 hierarchy可以附加多个 subsystem。</p>
<p>一个进程可以作为多个 cgroup的成员,但是这些 cgroup必须在不同的 hierarchy中。</p>
<p>一个进程fork出子进程时,子进程是和父进程在同一个 cgroup中的,也可以根据需要将其移动到其他 cgroup中。</p>
</blockquote>
<h3 id="Cgroups-实战"><a href="#Cgroups-实战" class="headerlink" title="Cgroups 实战"></a>Cgroups 实战</h3><p>我们安装下面的方式即可创建一个cgroup，这个cgroup在子系统cpu所附着的Hierarchy上。</p>
<p>只需要创建一个文件夹，cgroup就被创建了。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-4-4-centos cpu]<span class="comment"># cd /sys/fs/cgroup/cpu</span></span><br><span class="line">[root@VM-4-4-centos cpu]<span class="comment"># mkdir my-cpu</span></span><br><span class="line">[root@VM-4-4-centos cpu]<span class="comment"># cd my-cpu/</span></span><br><span class="line">[root@VM-4-4-centos my-cpu]<span class="comment"># ll</span></span><br><span class="line">total 0</span><br><span class="line">-rw-r--r-- 1 root root 0 Apr 17 14:32 cgroup.clone_children</span><br><span class="line">-rw-r--r-- 1 root root 0 Apr 17 14:32 cgroup.procs</span><br><span class="line">-r--r--r-- 1 root root 0 Apr 17 14:32 cpuacct.stat</span><br><span class="line">-rw-r--r-- 1 root root 0 Apr 17 14:32 cpuacct.usage</span><br><span class="line">-r--r--r-- 1 root root 0 Apr 17 14:32 cpuacct.usage_all</span><br><span class="line">-r--r--r-- 1 root root 0 Apr 17 14:32 cpuacct.usage_percpu</span><br><span class="line">-r--r--r-- 1 root root 0 Apr 17 14:32 cpuacct.usage_percpu_sys</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>接下来，我们来看两个文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-4-4-centos my-cpu]<span class="comment"># cat cpu.cfs_period_us </span></span><br><span class="line">100000</span><br><span class="line">[root@VM-4-4-centos my-cpu]<span class="comment"># cat cpu.cfs_quota_us </span></span><br><span class="line">-1</span><br></pre></td></tr></table></figure>



<blockquote>
<p>cfs_period_us用来配置时间周期长度，cfs_quota_us用来配置当前cgroup在设置的周期长度内所能使用的CPU时间数，两个文件配合起来设置CPU的使用上限。两个文件的单位都是微秒（us），cfs_period_us的取值范围为1毫秒（ms）到1秒（s），cfs_quota_us的取值大于1ms即可，如果cfs_quota_us的值为-1（默认值），表示不受cpu时间的限制。下面是几个例子：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1.限制只能使用1个CPU（每250ms能使用250ms的CPU时间）</span><br><span class="line">   # echo 250000 &gt; cpu.cfs_quota_us /* quota = 250ms */</span><br><span class="line">   # echo 250000 &gt; cpu.cfs_period_us /* period = 250ms */</span><br><span class="line"></span><br><span class="line">2.限制使用2个CPU（内核）（每500ms能使用1000ms的CPU时间，即使用两个内核）</span><br><span class="line">   # echo 1000000 &gt; cpu.cfs_quota_us /* quota = 1000ms */</span><br><span class="line">   # echo 500000 &gt; cpu.cfs_period_us /* period = 500ms */</span><br><span class="line"></span><br><span class="line">3.限制使用1个CPU的20%（每50ms能使用10ms的CPU时间，即使用一个CPU核心的20%）</span><br><span class="line">   # echo 10000 &gt; cpu.cfs_quota_us /* quota = 10ms */</span><br><span class="line">   # echo 50000 &gt; cpu.cfs_period_us /* period = 50ms */</span><br></pre></td></tr></table></figure>

<p>引用： <a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000008323952">原文链接</a></p>
</blockquote>
<p>紧接着我们编写一个CPU密集型的算法，计算斐波拉契数列第100000000项的最后4位数字。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> n = <span class="number">100000000</span>;    </span><br><span class="line">    <span class="type">int</span> a[] = &#123;<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>&#125;;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">3</span>;i&lt;=n;i++)&#123;</span><br><span class="line">        <span class="type">int</span>*fib = a-i+<span class="number">2</span>;</span><br><span class="line">        fib[i<span class="number">-2</span>] = fib[i<span class="number">-1</span>];</span><br><span class="line">        fib[i<span class="number">-1</span>] = fib[i];</span><br><span class="line">        fib[i] = (fib[i<span class="number">-1</span>]+fib[i<span class="number">-2</span>])%<span class="number">10000</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    cout&lt;&lt;a[<span class="number">2</span>]&lt;&lt;endl;    </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们运行他，发现大概执行了1秒钟</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-4-4-centos tmp]<span class="comment"># g++ main.cpp -o main &amp;&amp; time ./main</span></span><br><span class="line">6875</span><br><span class="line"></span><br><span class="line">real    0m1.020s</span><br><span class="line">user    0m0.967s</span><br><span class="line">sys     0m0.001s</span><br></pre></td></tr></table></figure>

<p>现在我们构建一个只占用10%CPU的Cgroups，并让这个进程运行在这个Cgroups中。我们可以看到，这个进程在9.610秒内占用了0.963秒的CPU时间，这和我们希望看到的10%的CPU时间是相符合的。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-4-4-centos tmp]<span class="comment"># echo 10000 &gt; /sys/fs/cgroup/cpu/my-cpu/cpu.cfs_quota_us</span></span><br><span class="line">[root@VM-4-4-centos tmp]<span class="comment"># echo 100000 &gt; /sys/fs/cgroup/cpu/my-cpu/cpu.cfs_period_us </span></span><br><span class="line">[root@VM-4-4-centos tmp]<span class="comment"># g++ main.cpp -o main &amp;&amp; time cgexec -g cpu:my-cpu ./main</span></span><br><span class="line">6875</span><br><span class="line"></span><br><span class="line">real    0m9.610s</span><br><span class="line">user    0m0.963s</span><br><span class="line">sys     0m0.005s</span><br></pre></td></tr></table></figure>

<p>类似如内存占用的实战，在<a target="_blank" rel="noopener" href="https://www.cnblogs.com/sparkdev/p/8296063.html">这里</a>可以看到更多</p>
<h2 id="Union-File-System"><a href="#Union-File-System" class="headerlink" title="Union File System"></a>Union File System</h2><blockquote>
<p>联合文件系统（Union File System）：2004年由纽约州立大学石溪分校开发，它可以把多个目录(也叫分支)内容联合挂载到同一个目录下，而目录的物理位置是分开的。UnionFS允许只读和可读写目录并存，就是说可同时删除和增加内容。</p>
<p>作者：<em>一叶</em></p>
<p>链接：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/3ba255463047">https://www.jianshu.com/p/3ba255463047</a></p>
</blockquote>
<blockquote>
<p>写时复制(copy-on-wrie,下文简称CoW),也叫隐式共享,是一种对可修改资源实现高效复制的资源管理技术。它的思想是,如果一个资源是重复的,但没有任何修改,这时并不需要立即创建一个新的资源,这个资源可以被新旧实例共享。创建新资源发生在第一次写操作,也就是对资源进行修改的时候。通过这种资源共享的方式,可以显著地减少未修改资源复制带来的消耗,但是也会在进行资源修改时增加小部分的开销。</p>
<p>引用： 原书27页</p>
</blockquote>
<h3 id="AUFS"><a href="#AUFS" class="headerlink" title="AUFS"></a>AUFS</h3><p> Advanced Multi-Layered Unification Filesystem 改写了UFS，提高其可靠性和性能。</p>
<h4 id="AUFS实战"><a href="#AUFS实战" class="headerlink" title="AUFS实战"></a>AUFS实战</h4><p>我们先创建如下目录</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-4-4-centos aufs]<span class="comment"># tree </span></span><br><span class="line">.</span><br><span class="line">├── container-layer</span><br><span class="line">├── image-layer1</span><br><span class="line">│   └── file1.txt</span><br><span class="line">├── image-layer2</span><br><span class="line">│   └── file2.txt</span><br><span class="line">├── image-layer3</span><br><span class="line">│   └── file3.txt</span><br><span class="line">├── image-layer4</span><br><span class="line">│   └── file4.txt</span><br><span class="line">└── mnt</span><br></pre></td></tr></table></figure>

<p>内容如下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-4-4-centos aufs]<span class="comment"># cat image-layer1/file1.txt </span></span><br><span class="line">I<span class="string">&#x27;m in layer1</span></span><br><span class="line"><span class="string">[root@VM-4-4-centos aufs]# cat image-layer2/file2.txt </span></span><br><span class="line"><span class="string">I&#x27;</span>m <span class="keyword">in</span> layer2</span><br><span class="line">[root@VM-4-4-centos aufs]<span class="comment"># cat image-layer3/file3.txt </span></span><br><span class="line">I<span class="string">&#x27;m in layer3</span></span><br><span class="line"><span class="string">[root@VM-4-4-centos aufs]# cat image-layer4/file4.txt </span></span><br><span class="line"><span class="string">I&#x27;</span>m <span class="keyword">in</span> layer4</span><br></pre></td></tr></table></figure>

<p>开始挂载</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-4-4-centos aufs]<span class="comment">#  sudo mount -t aufs -o dirs=container-layer:image-layer1:image-layer2:image-layer3:image-layer4 none mnt</span></span><br><span class="line">mount: /data/src/tmp/aufs/mnt: unknown filesystem <span class="built_in">type</span> <span class="string">&#x27;aufs&#x27;</span>.</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/dmw412724/article/details/107159288">GG</a> 现在的centos上的docker，使用的不是aufs，而是OverlayFS，不信你看</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-4-4-centos aufs]<span class="comment"># df</span></span><br><span class="line">Filesystem     1K-blocks     Used Available Use% Mounted on</span><br><span class="line">devtmpfs          407188        0    407188   0% /dev</span><br><span class="line">tmpfs             420616       48    420568   1% /dev/shm</span><br><span class="line">tmpfs             420616     1052    419564   1% /run</span><br><span class="line">tmpfs             420616        0    420616   0% /sys/fs/cgroup</span><br><span class="line">/dev/vda1       25736400 21166108   3421600  87% /</span><br><span class="line">overlay         25736400 21166108   3421600  87% /var/lib/docker/overlay2/665fa7b38b75b193df7995e1535782c88e9922d6097e16472ac94d254e18c850/merged</span><br><span class="line">overlay         25736400 21166108   3421600  87% /var/lib/docker/overlay2/1f2ddfe4b78e83f2ba5b721d167b584187726a3fae80ce4ffcf400fa0b0ad1db/merged</span><br><span class="line">overlay         25736400 21166108   3421600  87% /var/lib/docker/overlay2/d76eb09f0d9388bd10daeba94112025dd55c0b6c67cc37fd05ac6664fd4f9947/merged</span><br><span class="line">overlay         25736400 21166108   3421600  87% /var/lib/docker/overlay2/9c8e0bf244fc65294eb2d4455994ca470cd48d3a7b65318d7382bf53ac611cfe/merged</span><br><span class="line">overlay         25736400 21166108   3421600  87% /var/lib/docker/overlay2/0cbbbfc5ed25c5583abe765b06f367add27d0834cedea47e8e5bf12d633af1ee/merged</span><br><span class="line">overlay         25736400 21166108   3421600  87% /var/lib/docker/overlay2/434275a20afd962e4dfea51329f1520fad94ea49b2b9c3d299a06cbf55423b40/merged</span><br><span class="line">overlay         25736400 21166108   3421600  87% /var/lib/docker/overlay2/180399a29eeb51f456a165adf7ea52a79d1219882fc707b9988b93a8c60a2000/merged</span><br><span class="line">overlay         25736400 21166108   3421600  87% /var/lib/docker/overlay2/f7afc7f62355db8f11449d0559fad921c929418b5b8fd80c6b20e7db93054546/merged</span><br><span class="line">overlay         25736400 21166108   3421600  87% /var/lib/docker/overlay2/46d0b181bfd0218a5fa88f3ec0b3f55ef710fc5e8de9ebbac3dc8025c084a372/merged</span><br><span class="line">overlay         25736400 21166108   3421600  87% /var/lib/docker/overlay2/4b64e9d775bdc157a476a2b7edc6a8141916e57107f2bca0bb795bd18ebe79ea/merged</span><br><span class="line">tmpfs              84120        0     84120   0% /run/user/0</span><br></pre></td></tr></table></figure>

<h4 id="AUFS细节"><a href="#AUFS细节" class="headerlink" title="AUFS细节"></a>AUFS细节</h4><h5 id="读文件"><a href="#读文件" class="headerlink" title="读文件"></a>读文件</h5><p>下图是一个AUFS挂载情况，当我们对&#x2F;mnt处进行读取文件的时候，他会从顶层依次向下寻找，如果在layer4层找到了这个文件，则直接读取，如果找不到就递归向下寻找。</p>
<p><img src='/image-2021-04-17-16.17.00.000.svg'></img></p>
<h5 id="写文件"><a href="#写文件" class="headerlink" title="写文件"></a>写文件</h5><p>写文件比较特殊，如果底层文件无法写入，则通过COW技术直接写mnt层即可。如果底层文件可读写，则直接写入底层文件。</p>
<h5 id="删除文件"><a href="#删除文件" class="headerlink" title="删除文件"></a>删除文件</h5><ul>
<li>文件在mnt层，下层只读，且下层无此文件，直接删除</li>
<li>文件在mnt层，下层只读，且下层有此文件，删除mnt层，然后创建一个隐藏文件.wh.{filename}表示该文件被删除</li>
<li>文件在下层读写层，直接删除。</li>
</ul>
<h4 id="了解更多"><a href="#了解更多" class="headerlink" title="了解更多"></a>了解更多</h4><p><a target="_blank" rel="noopener" href="https://arkingc.github.io/2017/04/13/2017-04-13-docker-filesystem-aufs/">拓展阅读</a></p>
<h3 id="OverlayFS"><a href="#OverlayFS" class="headerlink" title="OverlayFS"></a>OverlayFS</h3><blockquote>
<p>如下图所示，Overlay在主机上用到2个目录，这2个目录被看成是overlay的层。<br>upperdir为容器层、lowerdir为镜像层使用联合挂载技术将它们挂载在同一目录(merged)下，提供统一视图</p>
<p><img src='/image-2021-04-17-16.28.41.938.png'></img></p>
<p>原文:  <a target="_blank" rel="noopener" href="https://docs.docker.com/storage/storagedriver/overlayfs-driver/">链接</a></p>
</blockquote>
<h4 id="了解更多-1"><a href="#了解更多-1" class="headerlink" title="了解更多"></a>了解更多</h4><p><a target="_blank" rel="noopener" href="https://docs.docker.com/storage/storagedriver/overlayfs-driver/">拓展阅读</a></p>
<h1 id="构造容器"><a href="#构造容器" class="headerlink" title="构造容器"></a>构造容器</h1><h2 id="Proc文件系统"><a href="#Proc文件系统" class="headerlink" title="Proc文件系统"></a>Proc文件系统</h2><blockquote>
<p>Linux下的proc文件系统是由内核提供的,它其实不是一个真正的文件系统只包含了系统运行时的信息(比如系统内存、 mount设备信息、一些硬件配置等),它只存在于内存中,而不占用外存空间。它以文件系统的形式,为访问内核数据的操作提供接口。实际上,很多系统工具都是简单地去读取这个文件系统的某个文件内容,比如 Ismo,其实就是cat<br>proc&#x2F;modules</p>
<p>当遍历这个目录的时候,会发现很多数字,这些都是为每个进程创建的空间,数字就是它们的PID。</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-4-4-centos aufs]<span class="comment"># ll /proc | head -n 15</span></span><br><span class="line">total 0</span><br><span class="line">dr-xr-xr-x  9 root             root         0 Apr  9 15:16 1</span><br><span class="line">dr-xr-xr-x  9 root             root         0 Apr 17 16:26 10</span><br><span class="line">dr-xr-xr-x  9 root             root         0 Apr 17 16:26 11</span><br><span class="line">dr-xr-xr-x  9 root             root         0 Apr 17 15:57 1102</span><br><span class="line">dr-xr-xr-x  9 root             root         0 Apr 17 15:57 1106</span><br><span class="line">dr-xr-xr-x  9 root             root         0 Apr 17 15:57 1108</span><br><span class="line">dr-xr-xr-x  9 root             root         0 Apr 17 15:57 1111</span><br><span class="line">dr-xr-xr-x  9 root             root         0 Apr 17 15:57 1112</span><br><span class="line">dr-xr-xr-x  9 root             root         0 Apr 17 15:57 1116</span><br><span class="line">dr-xr-xr-x  9 root             root         0 Apr 17 15:57 1135</span><br><span class="line">dr-xr-xr-x  9 root             root         0 Apr 17 15:57 1136</span><br><span class="line">dr-xr-xr-x  9 root             root         0 Apr 17 16:26 12</span><br><span class="line">dr-xr-xr-x  9 root             root         0 Apr 17 16:26 13</span><br><span class="line">dr-xr-xr-x  9 root             root         0 Apr 17 16:17 1411993</span><br></pre></td></tr></table></figure>



<p>目录结构</p>
<table>
<thead>
<tr>
<th>目录</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;proc&#x2F;N</td>
<td>PID为N的进程信息</td>
</tr>
<tr>
<td>&#x2F;proc&#x2F;N&#x2F;cmdline</td>
<td>进程启动命令</td>
</tr>
<tr>
<td>&#x2F;proc&#x2F;N&#x2F;cwd</td>
<td>链接到进程当前工作目录</td>
</tr>
<tr>
<td>&#x2F;proc&#x2F;N&#x2F;environ</td>
<td>进程环境变量列表</td>
</tr>
<tr>
<td>&#x2F;proc&#x2F;N&#x2F;exe</td>
<td>链接到进程的执行命令文件</td>
</tr>
<tr>
<td>&#x2F;proc&#x2F;N&#x2F;fd</td>
<td>包含进程相关的所有文件描述符</td>
</tr>
<tr>
<td>&#x2F;proc&#x2F;N&#x2F;maps</td>
<td>与进程相关的内存映射信息</td>
</tr>
<tr>
<td>&#x2F;proc&#x2F;N&#x2F;mem</td>
<td>指代进程持有的内存,不可读</td>
</tr>
<tr>
<td>&#x2F;proc&#x2F;N&#x2F;root</td>
<td>链接到进程的根目录</td>
</tr>
<tr>
<td>&#x2F;proc&#x2F;N&#x2F;stat</td>
<td>进程的状态</td>
</tr>
<tr>
<td>&#x2F;proc&#x2F;N&#x2F;statm</td>
<td>进程使用的内存状态</td>
</tr>
<tr>
<td>&#x2F;proc&#x2F;N&#x2F;status</td>
<td>进程状态信息,比stat&#x2F; statm更具可读性</td>
</tr>
<tr>
<td>&#x2F;proc&#x2F;self&#x2F;</td>
<td>链接到当前正在运行的进程</td>
</tr>
</tbody></table>
<h2 id="有Go我不用"><a href="#有Go我不用" class="headerlink" title="有Go我不用"></a>有Go我不用</h2><p>就用C++，哎，就是玩。</p>
<h2 id="3-1版本"><a href="#3-1版本" class="headerlink" title="3.1版本"></a>3.1版本</h2><p><a target="_blank" rel="noopener" href="https://github1s.com/fightinggg/pocker/tree/3.1">项目地址</a></p>
<p>直接看<code>main.cpp</code>中的主函数, 首先是解析参数，然后使用clone 系统调用制造一个进程。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    Param *param = ParamParse::<span class="built_in">parse</span>(argc, argv);</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> *stack = <span class="built_in">malloc</span>(FIBER_STACK);<span class="comment">//为子进程申请系统堆栈</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> containerFlag = SIGCHLD | CLONE_NEWUTS | CLONE_NEWPID</span><br><span class="line">                        | CLONE_NEWNS | CLONE_NEWNET | CLONE_NEWIPC | CLONE_NEWUSER;</span><br><span class="line">    <span class="type">int</span> pid = <span class="built_in">clone</span>(doContainer, (<span class="type">char</span> *) stack + FIBER_STACK, containerFlag, param);<span class="comment">//创建子线程</span></span><br><span class="line">    <span class="built_in">waitpid</span>(pid, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;parent exit &quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>然后看<code>main.cpp</code>的子进程， 这里挂在proc目录是为了隔离，然后由于我们并没有编写镜像，所以我们mock了一个只支持centos的镜像。紧接着就是子进程调用exec替换掉自己的代码。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">doContainer</span><span class="params">(<span class="type">void</span> *param)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> *runParam = (RunParam *) param;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">mount</span>(<span class="string">&quot;proc&quot;</span>, <span class="string">&quot;/proc&quot;</span>, <span class="string">&quot;proc&quot;</span>, MS_NOEXEC | MS_NOSUID | MS_NODEV, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;mount proc error&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (runParam-&gt;<span class="built_in">getImage</span>() == <span class="string">&quot;centos&quot;</span>) &#123;</span><br><span class="line">        vector&lt;string&gt; v = runParam-&gt;<span class="built_in">getExec</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (v.<span class="built_in">size</span>()) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="built_in">execlp</span>(v[<span class="number">0</span>].<span class="built_in">data</span>(), <span class="literal">nullptr</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                <span class="built_in">execlp</span>(v[<span class="number">0</span>].<span class="built_in">data</span>(), v[<span class="number">1</span>].<span class="built_in">data</span>(), <span class="literal">NULL</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                <span class="built_in">execlp</span>(v[<span class="number">0</span>].<span class="built_in">data</span>(), v[<span class="number">1</span>].<span class="built_in">data</span>(), v[<span class="number">2</span>].<span class="built_in">data</span>(), <span class="literal">NULL</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">                <span class="built_in">execlp</span>(v[<span class="number">0</span>].<span class="built_in">data</span>(), v[<span class="number">1</span>].<span class="built_in">data</span>(), v[<span class="number">2</span>].<span class="built_in">data</span>(), v[<span class="number">3</span>].<span class="built_in">data</span>(), <span class="literal">NULL</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                cerr &lt;&lt; <span class="string">&quot;too many params, only four params support&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;exec error: &quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;could not find image &#x27;&quot;</span> &lt;&lt; runParam-&gt;<span class="built_in">getImage</span>() &lt;&lt; <span class="string">&quot;&#x27;&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="编译运行3-1"><a href="#编译运行3-1" class="headerlink" title="编译运行3.1"></a>编译运行3.1</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> build</span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line">cmake ..</span><br><span class="line">make</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@wsx pocker]<span class="comment"># mkdir build</span></span><br><span class="line">[root@wsx pocker]<span class="comment"># cd build</span></span><br><span class="line">[root@wsx build]<span class="comment"># cmake ..</span></span><br><span class="line">-- The C compiler identification is GNU 8.3.1</span><br><span class="line">-- The CXX compiler identification is GNU 8.3.1</span><br><span class="line">-- Check <span class="keyword">for</span> working C compiler: /usr/bin/cc</span><br><span class="line">-- Check <span class="keyword">for</span> working C compiler: /usr/bin/cc -- works</span><br><span class="line">-- Detecting C compiler ABI info</span><br><span class="line">-- Detecting C compiler ABI info - <span class="keyword">done</span></span><br><span class="line">-- Detecting C compile features</span><br><span class="line">-- Detecting C compile features - <span class="keyword">done</span></span><br><span class="line">-- Check <span class="keyword">for</span> working CXX compiler: /usr/bin/c++</span><br><span class="line">-- Check <span class="keyword">for</span> working CXX compiler: /usr/bin/c++ -- works</span><br><span class="line">-- Detecting CXX compiler ABI info</span><br><span class="line">-- Detecting CXX compiler ABI info - <span class="keyword">done</span></span><br><span class="line">-- Detecting CXX compile features</span><br><span class="line">-- Detecting CXX compile features - <span class="keyword">done</span></span><br><span class="line">-- Configuring <span class="keyword">done</span></span><br><span class="line">-- Generating <span class="keyword">done</span></span><br><span class="line">-- Build files have been written to: /data/src/pocker/build</span><br><span class="line">[root@wsx build]<span class="comment"># make</span></span><br><span class="line">Scanning dependencies of target pocker</span><br><span class="line">[ 25%] Building CXX object CMakeFiles/pocker.dir/src/param/parse/ParamParse.cpp.o</span><br><span class="line">[ 50%] Building CXX object CMakeFiles/pocker.dir/src/param/parse/RunParamParse.cpp.o</span><br><span class="line">[ 75%] Building CXX object CMakeFiles/pocker.dir/src/main.cpp.o</span><br><span class="line">[100%] Linking CXX executable pocker</span><br><span class="line">[100%] Built target pocker</span><br></pre></td></tr></table></figure>

<p>默认的提示</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@wsx build]<span class="comment"># ./pocker </span></span><br><span class="line">please run:</span><br><span class="line">      ./pocker run --<span class="built_in">help</span></span><br></pre></td></tr></table></figure>

<p><code>pocker run</code>的提示</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@wsx build]<span class="comment"># ./pocker run --help</span></span><br><span class="line">usage: ./pocker [options] ... image...</span><br><span class="line">options:</span><br><span class="line">  -i, --interactive    interactive</span><br><span class="line">  -t, --<span class="built_in">tty</span>            <span class="built_in">tty</span></span><br><span class="line">  -d, --detach         detach</span><br><span class="line">  -?, --<span class="built_in">help</span>           <span class="built_in">print</span> this message</span><br></pre></td></tr></table></figure>

<p>调用ls指令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@wsx build]<span class="comment"># ./pocker run -it centos ls .</span></span><br><span class="line">CMakeCache.txt  CMakeFiles  cmake_install.cmake  Makefile  pocker</span><br><span class="line">parent <span class="built_in">exit</span> </span><br></pre></td></tr></table></figure>

<p>调用ps指令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@wsx build]<span class="comment"># ./pocker run -it centos ps aux</span></span><br><span class="line">    PID TTY          TIME CMD</span><br><span class="line">      1 pts/0    00:00:00 ps</span><br><span class="line">parent <span class="built_in">exit</span> </span><br></pre></td></tr></table></figure>

<p>调用bash指令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@wsx build]<span class="comment"># ./pocker run -it centos bash</span></span><br><span class="line">[nobody@wsx build]$ ps -ef</span><br><span class="line">UID          PID    PPID  C STIME TTY          TIME CMD</span><br><span class="line">nobody         1       0  0 02:38 pts/0    00:00:00 [bash]</span><br><span class="line">nobody        22       1  0 02:38 pts/0    00:00:00 ps -ef</span><br><span class="line">[nobody@wsx build]$ <span class="built_in">exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">parent <span class="built_in">exit</span> </span><br></pre></td></tr></table></figure>



<h3 id="pocker3-1-in-docker"><a href="#pocker3-1-in-docker" class="headerlink" title="pocker3.1 in docker"></a>pocker3.1 in docker</h3><p>笔者还为大家准备了一份开箱即用的3.1版本。大家可以一起来学习。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">s@s ~ % docker run  --privileged  -it --<span class="built_in">rm</span> 1144560553/pocker:3.1 bash </span><br><span class="line">Unable to find image <span class="string">&#x27;1144560553/pocker:3.1&#x27;</span> locally</span><br><span class="line">3.1: Pulling from 1144560553/pocker</span><br><span class="line">7a0437f04f83: Already exists </span><br><span class="line">4bbae049836d: Pull complete </span><br><span class="line">Digest: sha256:8340325bed1f0c26a1a24f0052e03fd06cb873d47a1b5d750f827d2ad4691b9e</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> 1144560553/pocker:3.1</span><br><span class="line">[root@ed07427b0ebd /]<span class="comment"># pocker </span></span><br><span class="line">please run:</span><br><span class="line">      pocker run --<span class="built_in">help</span></span><br><span class="line">[root@ed07427b0ebd /]<span class="comment"># pocker run --help</span></span><br><span class="line">usage: pocker [options] ... image...</span><br><span class="line">options:</span><br><span class="line">  -i, --interactive    interactive</span><br><span class="line">  -t, --<span class="built_in">tty</span>            <span class="built_in">tty</span></span><br><span class="line">  -d, --detach         detach</span><br><span class="line">  -?, --<span class="built_in">help</span>           <span class="built_in">print</span> this message</span><br><span class="line">[root@ed07427b0ebd /]<span class="comment"># pocker run -it centos ps ef</span></span><br><span class="line">  PID TTY          TIME CMD</span><br><span class="line">    1 pts/0    00:00:00 ps</span><br><span class="line">parent <span class="built_in">exit</span> </span><br><span class="line">[root@ed07427b0ebd /]<span class="comment"># pocker run -it centos ls . </span></span><br><span class="line">bin  dev  etc  home  lib  lib64  lost+found  media  mnt  opt  proc</span><br><span class="line">root  run  sbin  srv  sys  tmp  usr  var</span><br><span class="line">parent <span class="built_in">exit</span> </span><br><span class="line">[root@ed07427b0ebd /]<span class="comment"># pocker run -it centos bash</span></span><br><span class="line">[nobody@ed07427b0ebd /]$ ps -ef</span><br><span class="line">UID        PID  PPID  C STIME TTY          TIME CMD</span><br><span class="line">nobody       1     0  0 07:24 pts/0    00:00:00 [bash]</span><br><span class="line">nobody      14     1  0 07:24 pts/0    00:00:00 ps -ef</span><br><span class="line">[nobody@ed07427b0ebd /]$ <span class="built_in">exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">parent <span class="built_in">exit</span> </span><br><span class="line">[root@ed07427b0ebd /]<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure>



<h2 id="3-2-cpu版本"><a href="#3-2-cpu版本" class="headerlink" title="3.2-cpu版本"></a>3.2-cpu版本</h2><p>这个版本笔者主要增加了一些cpu的限制，先看main.cpp中多了一个函数，这个函数是在容器启动前就已经调用了的，目的就是创建CPU子系统，我们可以看到这里主要使用了system系统调用，在目录<code>/sys/fs/cgroup/cpu</code>下用容器的id为文件夹名字创建了一个cpu子系统，在其中修改cfs_quota_us和cfs_period_us来解决cpu资源的问题。具体可见[Cgroups 实战](#Cgroups 实战)。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">prepareContainer</span><span class="params">(RunParam *runParam)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// create cpu subsystem</span></span><br><span class="line">    <span class="type">char</span> cmd[<span class="number">128</span>];</span><br><span class="line">    string cmdList[] = &#123;</span><br><span class="line">            <span class="string">&quot;cd /sys/fs/cgroup/cpu &quot;</span>,</span><br><span class="line">            <span class="string">&quot;&amp;&amp; mkdir %s &quot;</span>,</span><br><span class="line">            <span class="string">&quot;&amp;&amp; cd %s &quot;</span>,</span><br><span class="line">            <span class="string">&quot;&amp;&amp; echo %d &gt; cpu.cfs_quota_us &quot;</span>,</span><br><span class="line">            <span class="string">&quot;&amp;&amp; echo 50000 &gt; cpu.cfs_period_us &quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line">    string cmdOrigin;</span><br><span class="line">    <span class="keyword">for</span> (string &amp;s:cmdList) &#123;</span><br><span class="line">        cmdOrigin += s;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">sprintf</span>(cmd, cmdOrigin.<span class="built_in">data</span>(),</span><br><span class="line">            runParam-&gt;<span class="built_in">getContainerId</span>().<span class="built_in">data</span>(),</span><br><span class="line">            runParam-&gt;<span class="built_in">getContainerId</span>().<span class="built_in">data</span>(),</span><br><span class="line">            <span class="built_in">int</span>(runParam-&gt;<span class="built_in">getCpus</span>() * <span class="number">50000</span>)</span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">system</span>(cmd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后就是在容器启动后增加了下面这一段代码, 依然使用系统调用system，把容器所在的进程ID加入到tasks文件中，其目的就是让当前进程加入cpu子系统，来限制cpu的使用率。然后为了测试cpu子系统的有效性，笔者还在其中加了一个0到1e9的for循环来完成一个计算密集型任务。pocker会输出这个任务所占用的时间（单位为秒）。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// add cpu subsystem</span></span><br><span class="line"><span class="type">char</span> cmd[<span class="number">128</span>];</span><br><span class="line"><span class="built_in">sprintf</span>(cmd, <span class="string">&quot;echo %d &gt;&gt; /sys/fs/cgroup/cpu/%s/tasks&quot;</span>,</span><br><span class="line">        <span class="built_in">getpid</span>(), runParam-&gt;<span class="built_in">getContainerId</span>().<span class="built_in">data</span>());</span><br><span class="line"><span class="built_in">system</span>(cmd);</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> cur = <span class="built_in">time</span>(<span class="number">0</span>);</span><br><span class="line"><span class="type">int</span> a = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1e9</span>; i++) &#123;</span><br><span class="line">    a += i;</span><br><span class="line">&#125;</span><br><span class="line">cout &lt;&lt; a &lt;&lt; endl;</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;cost: &quot;</span> &lt;&lt; <span class="built_in">time</span>(<span class="number">0</span>) - cur &lt;&lt; endl;</span><br></pre></td></tr></table></figure>

<p>当然笔者依然准备了一份开箱即用的docker版本，大家可以自行尝试。下面是笔者测试的结果。 我们可以看到当cpus取值为0.5的时候，花费了7秒，当取值为0.25的时候，花费了18秒。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">s@s ~ % docker run  --privileged  -it --<span class="built_in">rm</span> 1144560553/pocker:3.2-cpu bash</span><br><span class="line">Unable to find image <span class="string">&#x27;1144560553/pocker:3.2-cpu&#x27;</span> locally</span><br><span class="line">3.2-cpu: Pulling from 1144560553/pocker</span><br><span class="line">7a0437f04f83: Pull complete </span><br><span class="line">cc5cd42589c1: Pull complete </span><br><span class="line">Digest: sha256:01ac27156f599acfa588a51301455b92eca7c4963b0e6c6ab943d66f4c5cb06f</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> 1144560553/pocker:3.2-cpu</span><br><span class="line">[root@37ab95d1bfdb /]<span class="comment"># pocker</span></span><br><span class="line">please run:</span><br><span class="line">      pocker run --<span class="built_in">help</span></span><br><span class="line">[root@37ab95d1bfdb /]<span class="comment"># pocker run -idt --memory 50m --cpus 0.5 --memory-swap 1024m centos ps ef</span></span><br><span class="line">RunParam:: <span class="built_in">tty</span>: 1, interactive: 1, detach: 1, memory: 50, memorySwap: 1024, cpus: 0.500000, image: centos,containerId: 205b8eaf-76a3-474f-9a3f-4d5a9e5b64ad,containerName: </span><br><span class="line">-1243309311</span><br><span class="line">cost: 7</span><br><span class="line">  PID TTY          TIME CMD</span><br><span class="line">    1 pts/0    00:00:03 ps</span><br><span class="line">parent <span class="built_in">exit</span> </span><br><span class="line">[root@37ab95d1bfdb /]<span class="comment"># pocker run -idt --memory 50m --cpus 0.25 --memory-swap 1024m centos ps ef</span></span><br><span class="line">RunParam:: <span class="built_in">tty</span>: 1, interactive: 1, detach: 1, memory: 50, memorySwap: 1024, cpus: 0.250000, image: centos,containerId: 322904df-a8b0-46c4-b7c2-ec3e6ea66f17,containerName: </span><br><span class="line">-1243309311</span><br><span class="line">cost: 18</span><br><span class="line">  PID TTY          TIME CMD</span><br><span class="line">    1 pts/0    00:00:04 ps</span><br><span class="line">parent <span class="built_in">exit</span> </span><br></pre></td></tr></table></figure>



<h2 id="3-2-mem版本"><a href="#3-2-mem版本" class="headerlink" title="3.2-mem版本"></a>3.2-mem版本</h2><p>新增的主要部分还是在main.cpp中，这个部分完成了内存子系统，这里直接看到，我们在位置<code>/sys/fs/cgroup/memory</code>新建了一个文件夹，并限制了内存和交换内存的大小，注意到一旦进程发生了内存溢出，默认将会被kill</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// create memory subsystem</span></span><br><span class="line">cmdList = &#123;<span class="string">&quot;cd /sys/fs/cgroup/memory &quot;</span>, <span class="string">&quot;&amp;&amp; mkdir %s &quot;</span>,</span><br><span class="line">                          <span class="string">&quot;&amp;&amp; cd %s &quot;</span>, <span class="string">&quot;&amp;&amp; echo %d &gt; memory.limit_in_bytes &quot;</span>,</span><br><span class="line">                          <span class="string">&quot;&amp;&amp; echo %d &gt; memory.memsw.limit_in_bytes &quot;</span>&#125;;</span><br><span class="line"><span class="built_in">sprintf</span>(cmd, StringUtils::<span class="built_in">join</span>(cmdList).<span class="built_in">data</span>(),</span><br><span class="line">        runParam-&gt;<span class="built_in">getContainerId</span>().<span class="built_in">data</span>(), runParam-&gt;<span class="built_in">getContainerId</span>().<span class="built_in">data</span>(),</span><br><span class="line">        <span class="built_in">int</span>(runParam-&gt;<span class="built_in">getMemory</span>()), <span class="built_in">int</span>(runParam-&gt;<span class="built_in">getMemorySwap</span>()));</span><br><span class="line"><span class="built_in">system</span>(cmd);</span><br></pre></td></tr></table></figure>

<p>笔者还是准备了一份开箱即用的docker版本(以后的docker版本都将直接转移到账号fightinggg下，而不是1144560553)，大家可以直接尝试。</p>
<p>这里首先使用docker创建了一个pocker，然后使用pocker创建了一个内存空间10mb的容器，最后在容器中使用大量的内存，之后发现这个容器被Killed。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">s@s ~ % docker run  --privileged  -it --<span class="built_in">rm</span> fightinggg/pocker:3.2-mem bash</span><br><span class="line">[root@6b67dbf3b43e /]<span class="comment"># pocker run -itd -m 10m --memory-swap 10m centos bash</span></span><br><span class="line">RunParam:: <span class="built_in">tty</span>: 1, interactive: 1, detach: 1, memory: 10485760, memorySwap: 10485760, cpus: 1.000000, image: centos,containerId: 2b90e451-8d10-4efc-b105-42000930b51d,containerName: </span><br><span class="line">[nobody@6b67dbf3b43e /]$ bash -c <span class="string">&quot;arr=(1 2 3); for((i=1;i&lt;=1000000;i++));  do arr[i]=i; done; echo <span class="variable">$&#123;arr[@]&#125;</span>&quot;</span></span><br><span class="line">Killed</span><br><span class="line">[nobody@6b67dbf3b43e /]$ <span class="built_in">exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">container <span class="built_in">exit</span>, thanks <span class="keyword">for</span> using pocker </span><br><span class="line">[root@6b67dbf3b43e /]<span class="comment"># </span></span><br></pre></td></tr></table></figure>



<h1 id="构造镜像"><a href="#构造镜像" class="headerlink" title="构造镜像"></a>构造镜像</h1><h2 id="4-1-busybox版本"><a href="#4-1-busybox版本" class="headerlink" title="4.1-busybox版本"></a>4.1-busybox版本</h2><p>这个版本中，我们实现了容器根目录的隔离，首先从docker容器中导出busybox的文件系统，然后将其挂载到pocker所构造的容器中，主要代码在<a target="_blank" rel="noopener" href="https://github.com/fightinggg/pocker/commit/1d55e7326b1cb902ee8d9160f8e6c3ec354cde54#diff-34d21af3c614ea3cee120df276c9c4ae95053830d7f1d3deaf009a4625409ad2">main.cpp</a>中，这里增加了系统调用<code>SYS_pivot_root</code>，把busybox的文件系统挂在到当前根目录，然后卸载旧的根目录。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mount busyBox 1. change workdir</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">chdir</span>(busyBoxDir.<span class="built_in">data</span>())) &#123;</span><br><span class="line">    cerr &lt;&lt; <span class="string">&quot;chdir to busyBoxDir error&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// mount busyBox 2. mount busyBox</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">mount</span>(busyBoxDir.<span class="built_in">data</span>(), busyBoxDir.<span class="built_in">data</span>(), <span class="string">&quot;bind&quot;</span>, MS_BIND | MS_REC,</span><br><span class="line">            <span class="literal">NULL</span>)) &#123;</span><br><span class="line">    cerr &lt;&lt; <span class="string">&quot;mount busyBox error&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  String privotRootName = <span class="string">&quot;.pivot_root&quot;</span> + runParam-&gt;<span class="built_in">getContainerId</span>();</span><br><span class="line">  String privotRoot = busyBoxDir + <span class="string">&quot;/&quot;</span> + privotRootName;</span><br><span class="line">  <span class="comment">// mount busyBox 3. mkdir put_old</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">mkdir</span>(privotRoot.<span class="built_in">data</span>(), S_IRWXU | S_IRWXG | S_IRWXO)) &#123;</span><br><span class="line">    cerr &lt;&lt; <span class="string">&quot;mkdir privotRoot error&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// mount busyBox 4. privot_root()</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">syscall</span>(SYS_pivot_root, busyBoxDir.<span class="built_in">data</span>(), privotRoot.<span class="built_in">data</span>())) &#123;</span><br><span class="line">    cerr &lt;&lt; <span class="string">&quot;privot_root error&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// mount busyBox 5. to dir /</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">chdir</span>(<span class="string">&quot;/&quot;</span>)) &#123;</span><br><span class="line">    cerr &lt;&lt; <span class="string">&quot;chdir to / error&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// mount busyBox 6. unmount .privot_root</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">umount2</span>((<span class="string">&quot;/&quot;</span> + privotRootName).<span class="built_in">data</span>(), MNT_DETACH)) &#123;</span><br><span class="line">    cerr &lt;&lt; <span class="string">&quot;unmount .pivot_root  error &quot;</span> &lt;&lt; <span class="built_in">getErr</span>() &lt;&lt; endl;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// mount busyBox 7. delete dir</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">rmdir</span>((<span class="string">&quot;/&quot;</span> + privotRootName).<span class="built_in">data</span>())) &#123;</span><br><span class="line">    cerr &lt;&lt; <span class="string">&quot;rm .pivot_root  error &quot;</span> &lt;&lt; <span class="built_in">getErr</span>() &lt;&lt; endl;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>



<p>笔者还是准备了一个docker版本，可以看到这时候使用ls，已经能发现根目录下的文件系统发生了变化。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">s@s hexo-blog % docker run -it --<span class="built_in">rm</span> --privileged fightinggg/pocker:4.1-busybox  </span><br><span class="line">[root@2d2a5c1bcd01 /]<span class="comment"># pocker run -it busybox sh</span></span><br><span class="line">RunParam:: <span class="built_in">tty</span>: 1, interactive: 1, detach: 0, memory: 10485760, memorySwap: 10485760, cpus: 1.000000, image: busybox,containerId: 0ee090e5-9829-4140-bfd1-48982952f4e0,containerName: </span><br><span class="line">container begin: sh</span><br><span class="line">/ <span class="comment"># ps ef</span></span><br><span class="line">PID   USER     TIME  COMMAND</span><br><span class="line">    1 root      0:00 sh</span><br><span class="line">    4 root      0:00 ps ef</span><br><span class="line">/ <span class="comment"># ls -a</span></span><br><span class="line">.           ..          .dockerenv  bin         dev         etc         home        proc        root        sys         tmp         usr         var</span><br><span class="line">/ <span class="comment"># df</span></span><br><span class="line">Filesystem           1K-blocks      Used Available Use% Mounted on</span><br><span class="line">overlay               16447356   7816736   7775428  50% /</span><br><span class="line">/ <span class="comment"># exit</span></span><br><span class="line">container exited, status=0,  thanks <span class="keyword">for</span> using pocker</span><br><span class="line">[root@2d2a5c1bcd01 /]<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">s@s hexo-blog % </span><br></pre></td></tr></table></figure>



<h2 id="4-2-overlay版本"><a href="#4-2-overlay版本" class="headerlink" title="4.2-overlay版本"></a>4.2-overlay版本</h2><p>这部分笔者并没有选择和原书中一样的aufs文件系统，而是使用了overlay文件系统，哎就是玩。主要的修改还是在<code>main.cpp</code>中。</p>
<p>大概是先创建一个disk.img文件，然后将其挂载到目录disk下，在disk目录下创建三个文件夹，upper、tmp和overlay，最后使用overlay文件系统以busybox为lower构造出一个两层文件系统。</p>
<p>这里有一个很重要的点，为什么要挂载disk.img，首先注意到一个事实，docker默认使用overlay文件系统来构造容器，所以我们下面这个程序是有可能运行在overlay文件系统下的。</p>
<p>overlay文件系统挂载时对upper有一定的要求，这导致了overlay文件系统没办法做为upper层挂载在另一个overlay文件系统下。</p>
<p>所以我们必须虚拟一个文件系统。</p>
<p>挂载流程和代码都在下面</p>
<p><img src='/image-2021-06-04-23.22.00.000.svg'></img></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">String containerDataDir = containerDir + <span class="string">&quot;/&quot;</span> + runParam-&gt;<span class="built_in">getContainerId</span>();</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">mkdir</span>(containerDataDir.<span class="built_in">data</span>(), <span class="number">0777</span>)) &#123;</span><br><span class="line">  cerr &lt;&lt; <span class="string">&quot; mkdir &quot;</span> &lt;&lt; containerDataDir &lt;&lt; <span class="string">&quot; error&quot;</span> &lt;&lt; endl;</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">String diskFile = containerDataDir + <span class="string">&quot;/disk.img&quot;</span>;</span><br><span class="line">String containerDisk = containerDataDir + <span class="string">&quot;/disk&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// create container disk 1. create disk</span></span><br><span class="line"><span class="built_in">sprintf</span>(cmd, <span class="string">&quot;dd if=/dev/zero bs=1M count=20 of=%s&quot;</span>, diskFile.<span class="built_in">data</span>());</span><br><span class="line"><span class="built_in">system</span>(cmd);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. init file system</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">system</span>((<span class="string">&quot;mkfs.ext4 &quot;</span> + diskFile).<span class="built_in">data</span>())) &#123;</span><br><span class="line">  cerr &lt;&lt; <span class="string">&quot;mkfs error &quot;</span> &lt;&lt; diskFile &lt;&lt; endl;</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span>(containerDisk.<span class="built_in">data</span>(), <span class="number">0777</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. mount container disk system</span></span><br><span class="line"><span class="built_in">sprintf</span>(cmd, <span class="string">&quot;mount %s %s&quot;</span>, diskFile.<span class="built_in">data</span>(), containerDisk.<span class="built_in">data</span>());</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;mount upper: %s\n&quot;</span>, cmd);</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">system</span>(cmd)) &#123;</span><br><span class="line">  cerr &lt;&lt; <span class="string">&quot;mount &quot;</span> &lt;&lt; diskFile &lt;&lt; <span class="string">&quot; error&quot;</span> &lt;&lt; endl;</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">String containerUpper = containerDisk + <span class="string">&quot;/upper&quot;</span>;</span><br><span class="line">String containerTmp = containerDisk + <span class="string">&quot;/tmp&quot;</span>;</span><br><span class="line">String containerMerge = containerDisk + <span class="string">&quot;/overlay&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span>(containerUpper.<span class="built_in">data</span>(), <span class="number">0777</span>);</span><br><span class="line"><span class="built_in">mkdir</span>(containerTmp.<span class="built_in">data</span>(), <span class="number">0777</span>);</span><br><span class="line"><span class="built_in">mkdir</span>(containerMerge.<span class="built_in">data</span>(), <span class="number">0777</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// system((&quot;ls -al &quot; + containerDisk).data());</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. build overlay</span></span><br><span class="line"><span class="built_in">sprintf</span>(cmd,</span><br><span class="line">        <span class="string">&quot;mount -t overlay overlay &quot;</span></span><br><span class="line">        <span class="string">&quot;-olowerdir=%s,upperdir=%s,workdir=%s %s&quot;</span>,</span><br><span class="line">        busyBoxDir.<span class="built_in">data</span>(), containerUpper.<span class="built_in">data</span>(), containerTmp.<span class="built_in">data</span>(),</span><br><span class="line">        containerMerge.<span class="built_in">data</span>());</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;do: %s\n&quot;</span>, cmd);</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">system</span>(cmd)) &#123;</span><br><span class="line">  cerr &lt;&lt; <span class="string">&quot;build overlay error &quot;</span> &lt;&lt; <span class="built_in">getErr</span>() &lt;&lt; endl;</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>笔者依旧准备了一份开箱即用的docker版本。如下。首先演示了在第一个容器中创建文件abc，然后退出容器，接着在第二个进入第二个容器，查看目录，是看不到文件abc的。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">s@s pocker % docker run -it --rm --privileged fightinggg/pocker:<span class="number">4.2</span>-overlay bash</span><br><span class="line">Unable to find image <span class="string">&#x27;fightinggg/pocker:4.2-overlay&#x27;</span> locally</span><br><span class="line"><span class="number">4.2</span>-overlay: Pulling from fightinggg/pocker</span><br><span class="line"><span class="number">7</span>a0437f04f83: Already exists </span><br><span class="line"><span class="number">00386041</span>dce7: Pull complete </span><br><span class="line"><span class="number">7b</span>2a7c3db2a0: Pull complete </span><br><span class="line">eeb1e29037fb: Pull complete </span><br><span class="line"><span class="number">74f</span>885815b4e: Pull complete </span><br><span class="line">Digest: sha256:<span class="number">300f</span>607e39217465a547593fda5c93c2a4d20e133dab82a519127bec66976b1e</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> fightinggg/pocker:<span class="number">4.2</span>-overlay</span><br><span class="line">[root@e070166a0ba7 /]<span class="meta"># pocker run -it busybox sh</span></span><br><span class="line">RunParam:: tty: <span class="number">1</span>, interactive: <span class="number">1</span>, detach: <span class="number">0</span>, memory: <span class="number">10485760</span>, memorySwap: <span class="number">10485760</span>, cpus: <span class="number">1.000000</span>, image: busybox,containerId: f5212791-e818<span class="number">-4f</span>e2-b040-e7f779473e23,containerName: </span><br><span class="line"><span class="number">20</span>+<span class="number">0</span> records in</span><br><span class="line"><span class="number">20</span>+<span class="number">0</span> records out</span><br><span class="line"><span class="number">20971520</span> <span class="built_in">bytes</span> (<span class="number">21</span> MB, <span class="number">20</span> MiB) copied, <span class="number">0.0562303</span> s, <span class="number">373</span> MB/s</span><br><span class="line">mke2fs <span class="number">1.45</span><span class="number">.6</span> (<span class="number">20</span>-Mar<span class="number">-2020</span>)</span><br><span class="line">Discarding device blocks: done                            </span><br><span class="line">Creating filesystem with <span class="number">20480</span> <span class="number">1</span>k blocks <span class="keyword">and</span> <span class="number">5136</span> inodes</span><br><span class="line">Filesystem UUID: <span class="number">61b</span>1d479-fca0<span class="number">-41b</span>0<span class="number">-86b</span>e<span class="number">-5</span>d9c3c501714</span><br><span class="line">Superblock backups stored on blocks: </span><br><span class="line">    <span class="number">8193</span></span><br><span class="line"></span><br><span class="line">Allocating group tables: done                            </span><br><span class="line">Writing inode tables: <span class="function">done                            </span></span><br><span class="line"><span class="function">Creating <span class="title">journal</span> <span class="params">(<span class="number">1024</span> blocks)</span>: done</span></span><br><span class="line"><span class="function">Writing superblocks and filesystem accounting information: done</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">mount upper: mount /usr/local/pocker/data/containers/f5212791-e818<span class="number">-4f</span>e2-b040-e7f779473e23/disk.img /usr/local/pocker/data/containers/f5212791-e818<span class="number">-4f</span>e2-b040-e7f779473e23/disk</span></span><br><span class="line"><span class="function">do: mount -t overlay overlay -olowerdir=</span>/usr/local/pocker/data/images/busybox,upperdir=/usr/local/pocker/data/containers/f5212791-e818<span class="number">-4f</span>e2-b040-e7f779473e23/disk/upper,workdir=/usr/local/pocker/data/containers/f5212791-e818<span class="number">-4f</span>e2-b040-e7f779473e23/disk/tmp /usr/local/pocker/data/containers/f5212791-e818<span class="number">-4f</span>e2-b040-e7f779473e23/disk/overlay</span><br><span class="line">container begin: sh</span><br><span class="line">/ <span class="meta"># ls</span></span><br><span class="line">bin   dev   etc   home  proc  root  sys   tmp   usr   var</span><br><span class="line">/ <span class="meta"># mkdir abc</span></span><br><span class="line">/ <span class="meta"># ls</span></span><br><span class="line">abc   bin   dev   etc   home  proc  root  sys   tmp   usr   var</span><br><span class="line">/ <span class="meta"># exit</span></span><br><span class="line">container exited, status=<span class="number">0</span>,  thanks <span class="keyword">for</span> <span class="keyword">using</span> pocker</span><br><span class="line">[root@e070166a0ba7 /]<span class="meta"># pocker run -it busybox sh</span></span><br><span class="line">RunParam:: tty: <span class="number">1</span>, interactive: <span class="number">1</span>, detach: <span class="number">0</span>, memory: <span class="number">10485760</span>, memorySwap: <span class="number">10485760</span>, cpus: <span class="number">1.000000</span>, image: busybox,containerId: <span class="number">276</span>d1b7b<span class="number">-72</span>de<span class="number">-4538</span><span class="number">-8b</span>39-fbfb469ae930,containerName: </span><br><span class="line"><span class="number">20</span>+<span class="number">0</span> records in</span><br><span class="line"><span class="number">20</span>+<span class="number">0</span> records out</span><br><span class="line"><span class="number">20971520</span> <span class="built_in">bytes</span> (<span class="number">21</span> MB, <span class="number">20</span> MiB) copied, <span class="number">0.0629004</span> s, <span class="number">333</span> MB/s</span><br><span class="line">mke2fs <span class="number">1.45</span><span class="number">.6</span> (<span class="number">20</span>-Mar<span class="number">-2020</span>)</span><br><span class="line">Discarding device blocks: done                            </span><br><span class="line">Creating filesystem with <span class="number">20480</span> <span class="number">1</span>k blocks <span class="keyword">and</span> <span class="number">5136</span> inodes</span><br><span class="line">Filesystem UUID: <span class="number">4231f</span>410<span class="number">-3e32</span><span class="number">-4486</span><span class="number">-9</span>d09<span class="number">-2</span>de705563eb8</span><br><span class="line">Superblock backups stored on blocks: </span><br><span class="line">    <span class="number">8193</span></span><br><span class="line"></span><br><span class="line">Allocating group tables: done                            </span><br><span class="line">Writing inode tables: done                            </span><br><span class="line">Creating <span class="built_in">journal</span> (<span class="number">1024</span> blocks): done</span><br><span class="line">Writing superblocks <span class="keyword">and</span> filesystem accounting information: done</span><br><span class="line"></span><br><span class="line">mount upper: mount /usr/local/pocker/data/containers/<span class="number">276</span>d1b7b<span class="number">-72</span>de<span class="number">-4538</span><span class="number">-8b</span>39-fbfb469ae930/disk.img /usr/local/pocker/data/containers/<span class="number">276</span>d1b7b<span class="number">-72</span>de<span class="number">-4538</span><span class="number">-8b</span>39-fbfb469ae930/disk</span><br><span class="line"><span class="keyword">do</span>: mount -t overlay overlay -olowerdir=/usr/local/pocker/data/images/busybox,upperdir=/usr/local/pocker/data/containers/<span class="number">276</span>d1b7b<span class="number">-72</span>de<span class="number">-4538</span><span class="number">-8b</span>39-fbfb469ae930/disk/upper,workdir=/usr/local/pocker/data/containers/<span class="number">276</span>d1b7b<span class="number">-72</span>de<span class="number">-4538</span><span class="number">-8b</span>39-fbfb469ae930/disk/tmp /usr/local/pocker/data/containers/<span class="number">276</span>d1b7b<span class="number">-72</span>de<span class="number">-4538</span><span class="number">-8b</span>39-fbfb469ae930/disk/overlay</span><br><span class="line">container begin: sh</span><br><span class="line">/ <span class="meta"># ls</span></span><br><span class="line">bin   dev   etc   home  proc  root  sys   tmp   usr   var</span><br><span class="line">/ <span class="meta"># exit</span></span><br><span class="line">container exited, status=<span class="number">0</span>,  thanks <span class="keyword">for</span> <span class="keyword">using</span> pocker</span><br><span class="line">[root@e070166a0ba7 /]<span class="meta"># exit</span></span><br><span class="line">exit</span><br><span class="line">s@s pocker % </span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="4-3-volumes版本"><a href="#4-3-volumes版本" class="headerlink" title="4.3-volumes版本"></a>4.3-volumes版本</h2><p>今天去拍毕业照了，累了一整天，哎，真累，无聊中得到了两个点：</p>
<ul>
<li>仔细想了想，4.2中让pocker去适配操作系统的文件系统，有点不太合理，我觉得应该pocker还是不应该管操作系统的文件系统是哪个具体的类型，让用户自己去挂载ext4就可以了，没必要在程序中搞。</li>
<li>Java代码写C++真是shit到家了，我全给他改成了下划线命名。</li>
</ul>
<p>然后步入正题，在4.2版本中我们注意到换根以后，卸载privot以前，可以做一些文件映射，于是笔者直接使用mount指令将其挂载，实现了容器数据的持久化，但是由于笔者使用的命令行框架似乎不支持数组格式的flag，所以目前只能映射一个目录。这个以后应该会修复，新增代码如下，非常简单。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">pre_umount_privot</span><span class="params">(run_param *arg_run_param, string privot_root_name)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!arg_run_param-&gt;volumes.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">    <span class="keyword">auto</span> v = arg_run_param-&gt;volumes[<span class="number">0</span>];</span><br><span class="line">    string src = <span class="string">&quot;/&quot;</span> + privot_root_name + <span class="string">&quot;/&quot;</span> + v.from;</span><br><span class="line">    <span class="built_in">system</span>((<span class="string">&quot;mkdir -p &quot;</span> + v.to).<span class="built_in">data</span>());</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">mount</span>(src.<span class="built_in">data</span>(), v.to.<span class="built_in">data</span>(), <span class="literal">NULL</span>, MS_BIND, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">      cerr &lt;&lt; <span class="string">&quot;mount &quot;</span> &lt;&lt; v.from &lt;&lt; <span class="string">&quot; to &quot;</span> &lt;&lt; v.to &lt;&lt; <span class="string">&quot; failed&quot;</span> &lt;&lt; <span class="built_in">getErr</span>()</span><br><span class="line">           &lt;&lt; endl;</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>当然笔者还是准备了一个非常nice的docker版本，专门给懒人用的，下面是例子。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">s@s ~ % docker run -it --<span class="built_in">rm</span> --privileged fightinggg/pocker:4.3-volumes </span><br><span class="line">Unable to find image <span class="string">&#x27;fightinggg/pocker:4.3-volumes&#x27;</span> locally</span><br><span class="line">4.3-volumes: Pulling from fightinggg/pocker</span><br><span class="line">7a0437f04f83: Already exists </span><br><span class="line">00386041dce7: Already exists </span><br><span class="line">06435815e90c: Pull complete </span><br><span class="line">7e9a89da8fed: Pull complete </span><br><span class="line">16d9b87459ec: Pull complete </span><br><span class="line">Digest: sha256:f6314e114d6bd6bed21c6749c38b4636d1db51b22f8ab575bbdf72ccd8307dd2</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> fightinggg/pocker:4.3-volumes</span><br><span class="line">[root@1e558fec41d2 /]<span class="comment"># pocker run -it -v /:/hostdir/root busybox sh</span></span><br><span class="line">run_param:: <span class="built_in">tty</span>: 1, interactive: 1, detach: 0, memory: 10485760, memory_swap: 10485760, cpus: 1.000000, image: busybox,volumes: [ (from: /, to: /hostdir/root)]<span class="built_in">id</span>: 744a37f3-a390-4faf-8fbb-3baa43b62988,name: </span><br><span class="line">20+0 records <span class="keyword">in</span></span><br><span class="line">20+0 records out</span><br><span class="line">20971520 bytes (21 MB, 20 MiB) copied, 0.0395407 s, 530 MB/s</span><br><span class="line">mke2fs 1.45.6 (20-Mar-2020)</span><br><span class="line">Discarding device blocks: <span class="keyword">done</span>                            </span><br><span class="line">Creating filesystem with 20480 1k blocks and 5136 inodes</span><br><span class="line">Filesystem UUID: d46262a1-0cc4-46a0-ac1b-1fd908c8fa28</span><br><span class="line">Superblock backups stored on blocks: </span><br><span class="line">    8193</span><br><span class="line"></span><br><span class="line">Allocating group tables: <span class="keyword">done</span>                            </span><br><span class="line">Writing inode tables: <span class="keyword">done</span>                            </span><br><span class="line">Creating journal (1024 blocks): <span class="keyword">done</span></span><br><span class="line">Writing superblocks and filesystem accounting information: <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">mount upper: mount /usr/local/pocker/data/containers/744a37f3-a390-4faf-8fbb-3baa43b62988/disk.img /usr/local/pocker/data/containers/744a37f3-a390-4faf-8fbb-3baa43b62988/disk</span><br><span class="line"><span class="keyword">do</span>: mount -t overlay overlay -olowerdir=/usr/local/pocker/data/images/busybox,upperdir=/usr/local/pocker/data/containers/744a37f3-a390-4faf-8fbb-3baa43b62988/disk/upper,workdir=/usr/local/pocker/data/containers/744a37f3-a390-4faf-8fbb-3baa43b62988/disk/tmp /usr/local/pocker/data/containers/744a37f3-a390-4faf-8fbb-3baa43b62988/disk/overlay</span><br><span class="line">container begin: sh</span><br><span class="line">/ <span class="comment"># ls</span></span><br><span class="line">bin      dev      etc      home     hostdir  proc     root     sys      tmp      usr      var</span><br><span class="line">/ <span class="comment"># cd hostdir</span></span><br><span class="line">/hostdir <span class="comment"># ls</span></span><br><span class="line">root</span><br><span class="line">/hostdir <span class="comment"># cd root</span></span><br><span class="line">/hostdir/root <span class="comment"># ls</span></span><br><span class="line">bin         etc         lib         lost+found  mnt         proc        run         srv         tmp         var</span><br><span class="line">dev         home        lib64       media       opt         root        sbin        sys         usr</span><br><span class="line">/hostdir/root <span class="comment"># mkdir containerCreateDir</span></span><br><span class="line">/hostdir/root <span class="comment"># exit</span></span><br><span class="line">container exited, status=0,  thanks <span class="keyword">for</span> using pocker</span><br><span class="line">[root@1e558fec41d2 /]<span class="comment"># ls</span></span><br><span class="line">bin  containerCreateDir  dev  etc  home  lib  lib64  lost+found  media    mnt  opt  proc    root  run  sbin  srv  sys  tmp    usr  var</span><br><span class="line">[root@1e558fec41d2 /]<span class="comment"># </span></span><br></pre></td></tr></table></figure>





<h1 id="容器进阶"><a href="#容器进阶" class="headerlink" title="容器进阶"></a>容器进阶</h1><p>笔者不准备实现这部分代码了。</p>
<p>5.1实现后台运行只需要将容器变为守护进程，让init收管即可</p>
<p>5.2实现查看运行中的容器是crud，把本地json文件当做了数据库</p>
<p>5.3实现查看容器日志只需要重定向容器的输出到文件中即可</p>
<p>5.4实现进入容器还是有点意思的，需要使用系统调用setns进入和容器相同的名称空间即可</p>
<p>5.5停止容器实际上只是发了一个kill信号</p>
<p>5.6删除容器清理一下就好了</p>
<p>5.7通过容器制作镜像只需要提前保留容器的upper文件系统，之后自己合并即可</p>
<p>5.8配置环境变量也只需要简简单单的在宿主进程进入容器时配置即可</p>
<h1 id="容器网络"><a href="#容器网络" class="headerlink" title="容器网络"></a>容器网络</h1><p>这部分过于偏向于计算机网络，对于这部分，笔者后面会专门出一篇Blog进行介绍。</p>
<p>这部分代码笔者也不准备实现。关于容器网络部分，笔者第一次接触到是在《Kubernetes权威指南：从Docker到Kubernetes实践全接触》（第2版）-2016.10-电工-P519-龚正，吴治辉，王伟 等 的第三章第七节网络原理中，这两本书的这两个地方中有很多重复的地方。</p>
<p>至此，笔者的Pocker项目也将会告一段落了。</p>
<h1 id="高级实践"><a href="#高级实践" class="headerlink" title="高级实践"></a>高级实践</h1><p>这部分介绍一些名词，希望可以体会到其中的设计理念。</p>
<h2 id="OCI"><a href="#OCI" class="headerlink" title="OCI"></a>OCI</h2><p>Open Container Initiative 是一个组织，是Linux基金会在2015年成立的，是一个定义容器标准的组织。</p>
<h2 id="runC"><a href="#runC" class="headerlink" title="runC"></a>runC</h2><p>runC是一个容器引擎，他主要用于构造、运行容器。</p>
<blockquote>
<p>runC是个轻量级的容器运行引擎， 包括所有 Docker 使用的和容器相关的系统调用的代码。</p>
<p>runC的目标就是去构造到处都可以运行的标准容器。</p>
<p>引用： 原书177页</p>
</blockquote>
<p>runC的流程和pocker的流程是比较类似的，pocker只是个小demo，毕竟全部加起来也就几百行代码，他没有使用任何设计模式。</p>
<blockquote>
<p>代码读到这里,应该可以大概理解runC创建容器的整个过程了,如下</p>
<p>1.读取配置文件。</p>
<p>2.设置 rootfilesystem</p>
<p>3.使用 factory创建容器,各个系统平台均有不同实现。</p>
<p>4.创建容器的初始化进程 process</p>
<p>5.设置容器的输出管道,主要是Go的 pipes</p>
<p>6.执行 Container. Start)启动物理的容器</p>
<p>7.回调init方法重新初始化容器进程。</p>
<p>runC父进程等待子进程初始化成功后退出。</p>
<p>可以看到,具体的执行流程涉及3个概念: process、 container、 factory。 factory用来创建容器, process 负责进程之间的通信和启动容器</p>
<p>引用： 原书185页</p>
</blockquote>
<h2 id="Containerd"><a href="#Containerd" class="headerlink" title="Containerd"></a>Containerd</h2><p>containerd是一个守护进程，专注于容器的生命周期管理，方便容器编排。当然containerd只是docker的一部分，他不负责镜像的构造。</p>
<blockquote>
<p>每个 contained只负责一台机器,Pul镜像、对容器的操作(启动、停止等)、网络、存储都<br>是由 container完成的。具体运行容器由runC负责。</p>
</blockquote>
<h2 id="CRI容器引擎"><a href="#CRI容器引擎" class="headerlink" title="CRI容器引擎"></a>CRI容器引擎</h2><p>CRI是 Container Runtime Interface ，即容器运行时，众所周知，容器不只docker这一个软件支持，还有很多其他的支持容器的软件，k8s是负责容器编排的，k8s定义了一套CRI标准，只要你的容器支持CRI，那么k8s就可以帮助你管理他。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">classDiagram</span><br><span class="line">  CRI &lt;|.. docker</span><br><span class="line">  CRI &lt;|.. podman</span><br><span class="line">  CRI &lt;|.. LXC</span><br><span class="line">  CRI &lt;|.. others</span><br></pre></td></tr></table></figure>











                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/matery/about" rel="external nofollow noreferrer">fightinggg</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://fightinggg.github.io/matery/matery/QRN6OO.html">http://fightinggg.github.io/matery/matery/QRN6OO.html</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/matery/about" target="_blank">fightinggg</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/matery/tags/%E8%AF%BB%E4%B9%A6/">
                                    <span class="chip bg-color">读书</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/matery/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/matery/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/matery/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/matery/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/matery/QRNM0C.html">
                    <div class="card-image">
                        
                        
                        <img src="/matery/medias/featureimages/23.jpg" class="responsive-img" alt="CICD">
                        
                        <span class="card-title">CICD</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            nexthexonextbutterflyvolantisyearnyiliashokaindigoapollolandscapecactusmateryicarusfluidmaterial

CI&#x2F;CD持续集成、持续交付、持续
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-04-16
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/matery/categories/Others/" class="post-category">
                                    Others
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/matery/QRCS8O.html">
                    <div class="card-image">
                        
                        
                        <img src="/matery/medias/featureimages/7.jpg" class="responsive-img" alt="滴滴笔试题">
                        
                        <span class="card-title">滴滴笔试题</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            nexthexonextbutterflyvolantisyearnyiliashokaindigoapollolandscapecactusmateryicarusfluidmaterial



总揽两题都是10行代码不到就写了
第一题
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-04-10
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/matery/categories/%E5%AE%9E%E4%B9%A0/" class="post-category">
                                    实习
                                </a>
                            
                            <a href="/matery/categories/%E5%AE%9E%E4%B9%A0/%E7%AC%94%E8%AF%95/" class="post-category">
                                    笔试
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/matery/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/matery/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/matery/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/matery/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/matery/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/matery/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/matery/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2023</span>
            
            <span id="year">2019</span>
            <a href="/matery/about" target="_blank">fightinggg</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/blinkfox" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1181062873@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1181062873" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1181062873" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/matery/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/matery/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/matery/libs/materialize/materialize.min.js"></script>
    <script src="/matery/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/matery/libs/aos/aos.js"></script>
    <script src="/matery/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/matery/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/matery/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/matery/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/matery/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

	
    

    

    

    
    <script src="/matery/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
